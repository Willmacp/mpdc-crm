<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MPDC Stakeholder CRM</title>
<!-- Build r31 — dependent sub-filters + “keep open until sub selected” lock -->
<style>
  :root{
    --accent:#5f809b;
    --accent-700:#3f5b6f;
    --accent-50:#f5f9fe;
    --accent-100:#eaf3fb;
    --accent-200:#d6e6f4;
    --grey:#6d6e71;
    --text:#163046;

    --bg:#ffffff;
    --card:#ffffff;
    --border:#cfe0f1;

    --shadow-sm:0 1px 2px rgba(11,41,64,.06);
    --shadow:0 8px 24px rgba(11,41,64,.08);
    --shadow-md:0 10px 28px rgba(11,41,64,.12);
  }

  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

  .head-band{
    background: linear-gradient(180deg, rgba(95,128,155,.22) 0%, rgba(95,128,155,.12) 55%, rgba(255,255,255,0) 100%);
    border-bottom:1px solid var(--border);
    box-shadow: var(--shadow-sm);
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px 16px}

  .brand{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:22px;margin:0}

  .icon-cog{width:36px;height:36px;display:block}
  .logo-wrap{border-radius:8px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.5), 0 2px 8px rgba(11,41,64,.12)}

  .under-title{margin-top:10px}
  .toolbar{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;justify-content:space-between}
  .toolbar-left{display:flex;flex-direction:column;gap:8px;min-width:280px;flex:1}
  .toolbar-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  .btn{
    appearance:none;border:1px solid var(--border);background:var(--card);padding:8px 12px;border-radius:10px;
    cursor:pointer;font-size:14px;box-shadow:var(--shadow-sm);transition:.15s ease;color:#0e2b40;
    text-decoration:none;display:inline-flex;align-items:center;
  }
  .btn:hover{border-color:#9dc6e6;box-shadow:0 2px 6px rgba(14,43,64,.12)}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.primary:hover{background:var(--accent-700)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .search{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:10px;
    padding:6px 10px;box-shadow:var(--shadow-sm);min-width:260px}
  .search input{border:none;outline:none;font-size:14px;flex:1;background:transparent}
  .search .clear{border:none;background:transparent;cursor:pointer;color:#496b85}

  .panel{position:relative;display:inline-block}
  .pop{
    position:absolute;right:0;top:44px;min-width:260px;background:#fff;border:1px solid var(--border);
    border-radius:12px;box-shadow:var(--shadow-md);padding:12px;z-index:80;display:none
  }
  #groupsMenu{left:0;right:auto;min-width:520px;}
  #projectsMenu{left:0;right:auto;min-width:520px;}

  .groups-grid,.projects-grid{display:grid;grid-template-columns:repeat(3,minmax(160px,1fr));gap:8px 10px;max-height:360px;overflow:auto}
  @media (max-width:900px){ .groups-grid,.projects-grid{grid-template-columns:repeat(2,minmax(160px,1fr));} }
  @media (max-width:600px){ .groups-grid,.projects-grid{grid-template-columns:1fr;} }

  .tag{
    display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);
    border-radius:999px;background:#f7fbff;box-shadow:var(--shadow-sm);font-size:12px;user-select:none
  }
  .tag .tick{display:none;font-weight:700}
  .tag.selected{background:#4b7f6b;color:#fff;border-color:transparent;font-weight:600}
  .tag.selected .tick{display:inline}

  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#dff3e9;color:#2a5546;border:1px solid #cfe8dc}
  .stamp{font-size:12px;color:#3b5a73}

  main{display:flex;flex-direction:column;gap:16px;margin:18px 0 0}
  section.card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow-sm)}
  .card-head{
    display:flex;align-items:center;justify-content:space-between;padding:14px 16px;
    border-bottom:1px solid var(--border);
    background:linear-gradient(90deg, rgba(95,128,155,.22) 0%, rgba(95,128,155,.12) 55%, rgba(255,255,255,1) 100%);
    position:relative;
  }
  .card-head::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:6px;
    background: linear-gradient(180deg, #8fb0c7, #5f809b); opacity:.95;
    border-top-left-radius:14px; border-bottom-left-radius:14px;
  }
  .card-head h2{margin:0;font-size:18px}
  .card-head h2 .count{color:#325878;font-weight:600;margin-left:8px}
  .subhint{font-size:12px;color:#3b5a73}
  .card-head .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  .table-wrap{overflow:auto;max-height:420px}
  .scroll-top{height:14px;overflow-x:auto;overflow-y:hidden;border-bottom:1px solid var(--border);background:#fff}
  .scroll-spacer{height:1px;}

  table{border-collapse:separate;border-spacing:0;width:100%;min-width:1080px;background:#fff}
  thead th{position:sticky;top:0;background: linear-gradient(180deg, #eaf3fe, #dcebfb);z-index:1;font-weight:700;border-bottom:1px solid var(--border);color:#103650}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  tr:nth-child(even) td{background:#f9fbff}
  .muted{color:#5a6a7a}

  .w-name{max-width:220px}.w-org{max-width:220px}.w-group{max-width:240px}.w-role{max-width:160px}
  .w-email{max-width:240px}.w-phone{max-width:140px}.w-date{max-width:140px}
  .w-subj{max-width:260px}.w-notes{max-width:320px}
  .w-gp,.w-gs,.w-pp,.w-ps{max-width:200px}

  #tb-orgs tr[data-org],
  #tb-contacts tr[data-id],
  #tb-ints  tr[data-int]{cursor:pointer}
  #tb-orgs tr[data-org]:hover td,
  #tb-contacts tr[data-id]:hover td,
  #tb-ints  tr[data-int]:hover td{background:#edf6ff}
  tr.org-expander td, tr.contact-expander td, tr.int-expander td{background:#f6faff}

  .org-card,.contact-card,.int-card{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff;box-shadow:var(--shadow-sm)}
  .org-actions,.contact-actions,.int-actions{display:flex;gap:8px;margin:4px 0 6px;flex-wrap:wrap;align-items:center}
  .compact-line{display:flex;flex-wrap:wrap;gap:8px 10px;align-items:center;font-size:13px;line-height:1.25;margin:2px 0}
  .lab{color:#3b5a73}.sep{color:#b9d3e7}
  .mail{color:#0b65c2;text-decoration:none}.mail:hover{text-decoration:underline}

  .err{display:none;background:#ffeaea;border:1px solid #ffbcbc;color:#7a1e1e;border-radius:10px;padding:10px 12px;margin-top:12px}

  .foot-band{margin-top:22px;background: linear-gradient(0deg, rgba(95,128,155,.22) 0%, rgba(95,128,155,.12) 65%, rgba(255,255,255,0) 100%);border-top:1px solid var(--border);box-shadow: inset 0 1px 0 rgba(255,255,255,.65)}
  footer{padding:16px 0;color:#2d4c63;display:flex;justify-content:space-between;align-items:center;font-size:13px}
  a.top{color:#0b65c2;text-decoration:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<div class="head-band">
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo-wrap" aria-hidden="true">
          <!-- Cog icon -->
          <svg class="icon-cog" viewBox="0 0 24 24" role="img" aria-label="Settings">
            <path fill="#5f809b" d="M19.14,12.94a7.06,7.06,0,0,0,0-1.88l2-1.52a.5.5,0,0,0,.12-.65l-1.9-3.29a.5.5,0,0,0-.61-.22l-2.35,1a7.28,7.28,0,0,0-1.63-.95l-.36-2.52A.5.5,0,0,0,13.91,2H10.09a.5.5,0,0,0-.49.41L9.24,4.93a7.28,7.28,0,0,0-1.63.95l-2.35-1a.5.5,0,0,0-.61.22L2.75,8.37a.5.5,0,0,0,.12.65l2,1.52a7.06,7.06,0,0,0,0,1.88l-2,1.52a.5.5,0,0,
1.88l2,1.52a.5.5,0,0,0,.12.65l-1.9,3.29a.5.5,0,0,0,.61.22l2.35-1a7.28,7.28,0,0,0,1.63.95l.36,2.52a.5.5,0,0,0,.49.41h3.82a.5.5,0,0,0,.49-.41l.36-2.52a7.28,7.28,0,0,0,1.63-.95l2.35,1a.5.5,0,0,0,.61-.22l1.9-3.29a.5.5,0,0,0-.12-.65Zm-7.14,2.6a3.54,3.54,0,1,1,3.54-3.54A3.54,3.54,0,0,1,12,15.54Z"/>
          </svg>
        </div>

        <h1>Stakeholder CRM</h1>
      </div>

      <div class="under-title">
        <span class="stamp">Last updated: <span id="last-updated"></span></span>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">

          <!-- Search -->
          <div class="search">
            <input id="searchBox" type="text" placeholder="Search name, org, email…" />
            <button class="clear" id="clearSearch" title="Clear">✕</button>
          </div>

          <!-- Selected chips -->
          <div id="chipsRow"></div>

        </div>

        <!-- Filters -->
        <div class="toolbar-row">

          <!-- GROUPS MENU -->
          <div class="panel">
            <button class="btn" id="groupsBtn">Groups ▾</button>
            <div class="pop" id="groupsMenu">
              <div class="groups-grid" id="groupsGrid"></div>
            </div>
          </div>

          <!-- PROJECTS MENU -->
          <div class="panel">
            <button class="btn" id="projectsBtn">Projects ▾</button>
            <div class="pop" id="projectsMenu">
              <div class="projects-grid" id="projectsGrid"></div>
            </div>
          </div>

          <!-- Reset filters -->
          <button class="btn" id="resetFilters">Reset</button>

        </div>
      </div>
    </header>
  </div>
</div>

<main class="wrap">

  <!-- CONTACTS CARD -->
  <section class="card" id="card-contacts">
    <div class="card-head">
      <h2>Contacts <span class="count" id="count-contacts"></span></h2>
      <div class="right">
        <span class="subhint">Click a row to expand</span>
      </div>
    </div>

    <div class="scroll-top"><div class="scroll-spacer"></div></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="w-name">Name</th>
            <th class="w-org">Organisation</th>
            <th class="w-role">Role</th>
            <th class="w-email">Email</th>
            <th class="w-phone">Phone</th>
            <th class="w-gp">Group</th>
            <th class="w-gs">Sub-Group</th>
            <th class="w-pp">Project</th>
            <th class="w-ps">Sub-Project</th>
            <th class="w-date">Latest Interaction</th>
          </tr>
        </thead>
        <tbody id="tb-contacts"></tbody>
      </table>
    </div>

  </section>

  <!-- ORGANISATIONS CARD -->
  <section class="card" id="card-orgs">
    <div class="card-head">
      <h2>Organisations <span class="count" id="count-orgs"></span></h2>
      <div class="right">
        <span class="subhint">Click a row to expand</span>
      </div>
    </div>

    <div class="scroll-top"><div class="scroll-spacer"></div></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="w-org">Organisation</th>
            <th class="w-gp">Group</th>
            <th class="w-pp">Primary Project</th>
            <th class="w-date">Latest Interaction</th>
          </tr>
        </thead>
        <tbody id="tb-orgs"></tbody>
      </table>
    </div>

  </section>

  <!-- INTERACTIONS CARD -->
  <section class="card" id="card-ints">
    <div class="card-head">
      <h2>Interactions <span class="count" id="count-ints"></span></h2>
      <div class="right">
        <span class="subhint">Click a row to expand</span>
      </div>
    </div>

    <div class="scroll-top"><div class="scroll-spacer"></div></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="w-name">Name</th>
            <th class="w-date">Date</th>
            <th class="w-subj">Subject</th>
          </tr>
        </thead>
        <tbody id="tb-ints"></tbody>
      </table>
    </div>

  </section>

  <!-- Error box -->
  <div class="err" id="err"></div>

</main>

<div class="foot-band">
  <footer class="wrap">
    <div>Macquarie Point Development Corporation</div>
    <div><a class="top" href="#">Back to top ↑</a></div>
  </footer>
</div>

<script>
"use strict";

let RAW = [];
let FILTERS = {
  search:"",
  groups:[],
  subgroups:[],
  projects:[],
  subprojects:[]
};

/* -------------------------------
      LOAD JSON
-------------------------------- */
async function loadData(){
  try{
    const res = await fetch("data/data.json?" + Date.now());
    if(!res.ok) throw new Error("Could not load data.json");
    const data = await res.json();

    RAW = data;
    document.getElementById("last-updated").textContent = new Date().toLocaleString("en-AU");

    buildFilters(RAW);
    renderAll();

  } catch(err){
    const e = document.getElementById("err");
    e.style.display="block";
    e.textContent = "Error loading data.json: " + err.message;
  }
}

loadData();

/* -------------------------------
      FILTER BUILDERS
-------------------------------- */
function buildFilters(data){

  const groups = new Map();
  const projects = new Map();

  data.forEach(item=>{
    if(item.Group){
      if(!groups.has(item.Group)) groups.set(item.Group,new Set());
      if(item.SubGroup) groups.get(item.Group).add(item.SubGroup);
    }
    if(item.ProjectInterest){
      if(!projects.has(item.ProjectInterest)) projects.set(item.ProjectInterest,new Set());
      if(item.SubProject) projects.get(item.ProjectInterest).add(item.SubProject);
    }
  });

  const gGrid = document.getElementById("groupsGrid");
  gGrid.innerHTML="";
  [...groups.keys()].sort().forEach(g=>{
    const sg = [...groups.get(g)].sort();
    const div = document.createElement("div");
    div.innerHTML = `<div class="tag" data-type="group" data-value="${g}">
        <span>${g}</span><span class="tick">✓</span></div>`;
    gGrid.appendChild(div);
    sg.forEach(sub=>{
      const sdiv=document.createElement("div");
      sdiv.style.marginLeft="14px";
      sdiv.innerHTML = `<div class="tag" data-type="subgroup" data-value="${sub}" data-parent="${g}">
          <span>${sub}</span><span class="tick">✓</span></div>`;
      gGrid.appendChild(sdiv);
    });
  });

  const pGrid = document.getElementById("projectsGrid");
  pGrid.innerHTML="";
  [...projects.keys()].sort().forEach(p=>{
    const sp = [...projects.get(p)].sort();
    const div = document.createElement("div");
    div.innerHTML = `<div class="tag" data-type="project" data-value="${p}">
        <span>${p}</span><span class="tick">✓</span></div>`;
    pGrid.appendChild(div);
    sp.forEach(sub=>{
      const sdiv=document.createElement("div");
      sdiv.style.marginLeft="14px";
      sdiv.innerHTML = `<div class="tag" data-type="subproject" data-value="${sub}" data-parent="${p}">
          <span>${sub}</span><span class="tick">✓</span></div>`;
      pGrid.appendChild(sdiv);
    });
  });

  initTagListeners();
}

/* -------------------------------
      TAG LISTENERS
-------------------------------- */
function initTagListeners(){
  document.querySelectorAll(".tag").forEach(tag=>{
    tag.addEventListener("click",()=>{
      toggleTag(tag);
    });
  });
}

function toggleTag(tag){
  const type = tag.dataset.type;
  const value = tag.dataset.value;

  const isSelected = FILTERS[type + (type.endsWith("p")?"s":"s")]?.includes(value);
  if(isSelected){
    FILTERS[type + (type.endsWith("p")?"s":"s")] =
      FILTERS[type + (type.endsWith("p")?"s":"s")].filter(v=>v!==value);
    tag.classList.remove("selected");
  } else {
    FILTERS[type + (type.endsWith("p")?"s":"s")].push(value);
    tag.classList.add("selected");
  }

  maintainLockingLogic();
  updateChips();
  renderAll();
}

/* -------------------------------
   ADVANCED LOCKING BEHAVIOUR
-------------------------------- */
function maintainLockingLogic(){
  const {groups,subgroups} = FILTERS;
  if(groups.length === 1){
    document.querySelectorAll(`.tag[data-type="subgroup"]`).forEach(tag=>{
      if(tag.dataset.parent !== groups[0]){
        tag.classList.add("disabled");
      } else {
        tag.classList.remove("disabled");
      }
    });
  } else {
    document.querySelectorAll(`.tag[data-type="subgroup"]`).forEach(tag=>{
      tag.classList.remove("disabled");
    });
  }

  const {projects,subprojects} = FILTERS;
  if(projects.length === 1){
    document.querySelectorAll(`.tag[data-type="subproject"]`).forEach(tag=>{
      if(tag.dataset.parent !== projects[0]){
        tag.classList.add("disabled");
      } else {
        tag.classList.remove("disabled");
      }
    });
  } else {
    document.querySelectorAll(`.tag[data-type="subproject"]`).forEach(tag=>{
      tag.classList.remove("disabled");
    });
  }
}

/* -------------------------------
      CHIPS
-------------------------------- */
function updateChips(){
  const row = document.getElementById("chipsRow");
  row.innerHTML="";

  const addChip = (label,value,type)=>{
    const div=document.createElement("div");
    div.className="chip";
    div.innerHTML = `${label}: ${value} <button data-type="${type}" data-value="${value}" class="clear-chip">✕</button>`;
    row.appendChild(div);
  };

  FILTERS.groups.forEach(v=>addChip("Group",v,"group"));
  FILTERS.subgroups.forEach(v=>addChip("Sub-Group",v,"subgroup"));
  FILTERS.projects.forEach(v=>addChip("Project",v,"project"));
  FILTERS.subprojects.forEach(v=>addChip("Sub-Project",v,"subproject"));

  document.querySelectorAll(".clear-chip").forEach(btn=>{
    btn.onclick=()=>{
      const t=btn.dataset.type;
      const v=btn.dataset.value;
      FILTERS[t+"s"]=FILTERS[t+"s"].filter(x=>x!==v);
      document.querySelector(`.tag[data-type="${t}"][data-value="${v}"]`)?.classList.remove("selected");
      updateChips();
      renderAll();
    };
  });
}

/* -------------------------------
      SEARCH + RESET
-------------------------------- */
document.getElementById("searchBox").addEventListener("input",()=>{
  FILTERS.search = document.getElementById("searchBox").value.toLowerCase();
  renderAll();
});

document.getElementById("clearSearch").addEventListener("click",()=>{
  FILTERS.search="";
  document.getElementById("searchBox").value="";
  renderAll();
});

document.getElementById("resetFilters").addEventListener("click",()=>{
  FILTERS = {search:"",groups:[],subgroups:[],projects:[],subprojects:[]};
  document.getElementById("searchBox").value="";
  updateChips();
  document.querySelectorAll(".tag").forEach(tag=>tag.classList.remove("selected"));
  renderAll();
});

/* -------------------------------
      POPUP MENUS
-------------------------------- */
function closeAllMenus(){
  document.querySelectorAll(".pop").forEach(p=>p.style.display="none");
}
document.addEventListener("click",(e)=>{
  if(!e.target.closest(".panel")) closeAllMenus();
});

document.getElementById("groupsBtn").addEventListener("click",(e)=>{
  e.stopPropagation(); closeAllMenus();
  document.getElementById("groupsMenu").style.display="block";
});
document.getElementById("projectsBtn").addEventListener("click",(e)=>{
  e.stopPropagation(); closeAllMenus();
  document.getElementById("projectsMenu").style.display="block";
});

/* -------------------------------
      CORE FILTER LOGIC
-------------------------------- */
function passFilters(item){

  if(FILTERS.search){
    const s = FILTERS.search;
    if(!(item.Name||"").toLowerCase().includes(s)
      && !(item.Organisation||"").toLowerCase().includes(s)
      && !(item.Email||"").toLowerCase().includes(s))
      return false;
  }

  if(FILTERS.groups.length && !FILTERS.groups.includes(item.Group||"")) return false;
  if(FILTERS.subgroups.length && !FILTERS.subgroups.includes(item.SubGroup||"")) return false;
  if(FILTERS.projects.length && !FILTERS.projects.includes(item.ProjectInterest||"")) return false;
  if(FILTERS.subprojects.length && !FILTERS.subprojects.includes(item.SubProject||"")) return false;

  return true;
}

/* -------------------------------
      SAFE DATE PARSING (UPDATED)
-------------------------------- */
function parseDateSmart(input){
  if (!input) return null;
  const s = String(input).trim();
  if (!s) return null;

  // ISO YYYY-MM-DD / SharePoint / Outlook
  if (/^\d{4}-\d{2}-\d{2}/.test(s)){
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  // dd/mm/yyyy or d/m/yyyy
  const m1 = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m1){
    let d = parseInt(m1[1],10);
    let m = parseInt(m1[2],10);
    let y = parseInt(m1[3],10);
    if(y < 100) y += 2000;
    const dt = new Date(y, m-1, d);
    return isNaN(dt)?null:dt;
  }

  // 11 Oct 2024 etc.
  if (/[a-zA-Z]{3,}/.test(s)){
    const d = new Date(s);
    return isNaN(d)?null:d;
  }

  // fallback
  const loose = new Date(s);
  return isNaN(loose)?null:loose;
}

function fmtDate(v){
  const d = parseDateSmart(v);
  if(!d) return "";
  const day = d.getDate();
  const month = d.toLocaleString("en-AU",{month:"short"});
  const year = d.getFullYear();
  return `${day} ${month} ${year}`;
}
/* -------------------------------
      STATUS PILL
-------------------------------- */
function daysSince(d){
  const dt = parseDateSmart(d);
  if(!dt) return Infinity;
  const now = new Date();
  return Math.floor((now - dt)/(1000*60*60*24));
}

function pill(d){
  const n = daysSince(d);
  if(n === Infinity) return `<span class="muted">No date</span>`;
  if(n <= 30) return `<span class="muted" style="color:#2e7d60;font-weight:600">${n}d</span>`;
  if(n <= 60) return `<span class="muted" style="color:#c19a2e;font-weight:600">${n}d</span>`;
  return `<span class="muted" style="color:#aa0c38;font-weight:600">${n}d</span>`;
}

/* -------------------------------
      RENDER ALL TABLES
-------------------------------- */
function renderAll(){
  const list = RAW.filter(passFilters);
  renderContacts(list);
  renderOrgs(list);
  renderInts(list);
}

/* -------------------------------
      CONTACTS TABLE
-------------------------------- */
function renderContacts(list){
  const tb = document.getElementById("tb-contacts");
  tb.innerHTML="";

  let count = 0;

  list.forEach(item=>{
    const tr=document.createElement("tr");
    tr.setAttribute("data-id", item.ID || item.Email || "");

    tr.innerHTML = `
      <td class="w-name">${item.Name||""}</td>
      <td class="w-org">${item.Organisation||""}</td>
      <td class="w-role">${item.Role||""}</td>
      <td class="w-email">${item.Email||""}</td>
      <td class="w-phone">${item.Phone||""}</td>
      <td class="w-gp">${item.Group||""}</td>
      <td class="w-gs">${item.SubGroup||""}</td>
      <td class="w-pp">${item.ProjectInterest||""}</td>
      <td class="w-ps">${item.SubProject||""}</td>
      <td class="w-date">${fmtDate(item.LatestInteractionDate)} ${pill(item.LatestInteractionDate)}</td>
    `;

    tr.addEventListener("click",()=>toggleContactExpand(tr,item));
    tb.appendChild(tr);
    count++;
  });

  document.getElementById("count-contacts").textContent = `(${count})`;
}

/* -------------------------------
      ORGS TABLE
-------------------------------- */
function renderOrgs(list){
  const tb = document.getElementById("tb-orgs");
  tb.innerHTML="";

  const map = new Map();
  list.forEach(item=>{
    const org = item.Organisation || "Unknown";
    const d = parseDateSmart(item.LatestInteractionDate);
    if(!map.has(org)) map.set(org,{item,d});
    else {
      if(d && d > map.get(org).d){
        map.set(org,{item,d});
      }
    }
  });

  const rows=[...map.values()].sort((a,b)=>(b.d||0)-(a.d||0));
  let count = 0;

  rows.forEach(r=>{
    const i = r.item;
    const tr = document.createElement("tr");
    tr.setAttribute("data-org", i.Organisation||"");

    tr.innerHTML = `
      <td class="w-org">${i.Organisation||""}</td>
      <td class="w-gp">${i.Group||""}</td>
      <td class="w-pp">${i.ProjectInterest||""}</td>
      <td class="w-date">${fmtDate(i.LatestInteractionDate)} ${pill(i.LatestInteractionDate)}</td>
    `;

    tr.addEventListener("click",()=>toggleOrgExpand(tr,i));
    tb.appendChild(tr);
    count++;
  });

  document.getElementById("count-orgs").textContent = `(${count})`;
}

/* -------------------------------
      INTERACTIONS TABLE
-------------------------------- */
function renderInts(list){
  const tb = document.getElementById("tb-ints");
  tb.innerHTML="";

  const rows = list
    .filter(x=>x.Subject || x.LatestInteractionDate)
    .sort((a,b)=>{
      const da=parseDateSmart(a.LatestInteractionDate);
      const db=parseDateSmart(b.LatestInteractionDate);
      return (db||0)-(da||0);
    });

  let count=0;

  rows.forEach(i=>{
    const tr=document.createElement("tr");
    tr.setAttribute("data-int", i.ID || i.Email || "");

    tr.innerHTML = `
      <td class="w-name">${i.Name||""}</td>
      <td class="w-date">${fmtDate(i.LatestInteractionDate)}</td>
      <td class="w-subj">${i.Subject||""}</td>
    `;

    tr.addEventListener("click",()=>toggleIntExpand(tr,i));
    tb.appendChild(tr);
    count++;
  });

  document.getElementById("count-ints").textContent = `(${count})`;
}

/* -------------------------------
      EXPANDERS
-------------------------------- */
function toggleContactExpand(tr,item){
  const next = tr.nextElementSibling;
  if(next && next.classList.contains("contact-expander")){
    next.remove();
    return;
  }
  collapseAnyExpander();

  const exp = document.createElement("tr");
  exp.className="contact-expander";
  exp.innerHTML = `
    <td colspan="10">
      <div class="contact-card">
        <div class="compact-line"><span class="lab">Name:</span> ${item.Name||""}</div>
        <div class="compact-line"><span class="lab">Organisation:</span> ${item.Organisation||""}</div>
        <div class="compact-line"><span class="lab">Role:</span> ${item.Role||""}</div>
        <div class="compact-line"><span class="lab">Email:</span> <a class="mail" href="mailto:${item.Email||""}">${item.Email||""}</a></div>
        <div class="compact-line"><span class="lab">Phone:</span> ${item.Phone||""}</div>
        <div class="compact-line"><span class="lab">Group:</span> ${item.Group||""}</div>
        <div class="compact-line"><span class="lab">Sub-Group:</span> ${item.SubGroup||""}</div>
        <div class="compact-line"><span class="lab">Project:</span> ${item.ProjectInterest||""}</div>
        <div class="compact-line"><span class="lab">Sub-Project:</span> ${item.SubProject||""}</div>
        <div class="compact-line"><span class="lab">Latest Interaction:</span> 
            ${fmtDate(item.LatestInteractionDate)} (${pill(item.LatestInteractionDate)})</div>
      </div>
    </td>
  `;
  tr.after(exp);
}

function toggleOrgExpand(tr,item){
  const next = tr.nextElementSibling;
  if(next && next.classList.contains("org-expander")){
    next.remove();
    return;
  }
  collapseAnyExpander();

  const exp = document.createElement("tr");
  exp.className="org-expander";
  exp.innerHTML = `
    <td colspan="4">
      <div class="org-card">
        <div class="compact-line"><span class="lab">Organisation:</span> ${item.Organisation||""}</div>
        <div class="compact-line"><span class="lab">Group:</span> ${item.Group||""}</div>
        <div class="compact-line"><span class="lab">Primary Project:</span> ${item.ProjectInterest||""}</div>
        <div class="compact-line"><span class="lab">Latest Interaction:</span> 
            ${fmtDate(item.LatestInteractionDate)} (${pill(item.LatestInteractionDate)})</div>
      </div>
    </td>
  `;
  tr.after(exp);
}

function toggleIntExpand(tr,item){
  const next = tr.nextElementSibling;
  if(next && next.classList.contains("int-expander")){
    next.remove();
    return;
  }
  collapseAnyExpander();

  const exp = document.createElement("tr");
  exp.className="int-expander";
  exp.innerHTML = `
    <td colspan="3">
      <div class="int-card">
        <div class="compact-line"><span class="lab">Name:</span> ${item.Name||""}</div>
        <div class="compact-line"><span class="lab">Date:</span> ${fmtDate(item.LatestInteractionDate)}</div>
        <div class="compact-line"><span class="lab">Subject:</span> ${item.Subject||""}</div>
      </div>
    </td>
  `;
  tr.after(exp);
}

function collapseAnyExpander(){
  document.querySelectorAll(".contact-expander,.org-expander,.int-expander")
    .forEach(e=>e.remove());
}

/* -------------------------------
      EXPORT (unchanged)
-------------------------------- */
function exportCSV(){
  const csv = Papa.unparse(RAW);
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="stakeholders.csv";
  a.click();
}

/* -------------------------------
      END
-------------------------------- */
</script>

</body>
</html>
