<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>MPDC Stakeholder CRM</title>

<style>
/* -------------- YOUR ORIGINAL CSS (UNCHANGED) -------------- */

:root {
  --accent: #5f809b;
  --accent-700: #3f5b6f;
  --accent-50: #f5f9fe;
  --accent-100: #eaf3fb;
  --accent-200: #d6e6f4;
  --grey: #6d6e71;
  --text: #163046;

  --bg: #ffffff;
  --card: #ffffff;
  --border: #cfe0f1;

  --shadow-sm: 0 1px 2px rgba(11,41,64,.06);
  --shadow: 0 8px 24px rgba(11,41,64,.08);
  --shadow-md: 0 10px 28px rgba(11,41,64,.12);
}

html, body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
}

/* … (ALL YOUR EXISTING CSS REMAINS HERE EXACTLY AS IN YOUR FILE) … */

/* NOTE: Nothing in Part 1 is modified. All date logic appears in Part 2. */
</style>
</head>

<body>

<div class="head-band">
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo-wrap" aria-hidden="true">
          <svg class="icon-cog" viewBox="0 0 24 24">
            <path fill="#5f809b"
              d="M19.14,12.94a7.06,7.06,0,0,0,0-1.88l2-1.52a.5.5,0,0,0,.12-.65l-1.9-3.29a.5.5,0,0,0-.61-.22l-2.35,1a7.28,7.28,0,0,0-1.63-.95l-.36-2.52A.5.5,0,0,0,13.91,2H10.09a.5.5,0,0,0-.49.41L9.24,4.93a7.28,7.28,0,0,0-1.63.95l-2.35-1a.5.5,0,0,0-.61.22L2.75,8.37a.5.5,0,0,0,.12.65l2,1.52a7.06,7.06,0,0,0,0,1.88l-2,1.52a.5.5,0,0,0-.12.65l1.9,3.29a.5.5,0,0,0,.61.22l2.35-1a7.28,7.28,0,0,0,1.63.95l.36,2.52a.5.5,0,0,0,.49.41h3.82a.5.5,0,0,0,.49-.41l.36-2.52a7.28,7.28,0,0,0,1.63-.95l2.35,1a.5.5,0,0,0,.61-.22l1.9-3.29a.5.5,0,0,0-.12-.65Z"/>
          </svg>
        </div>

        <h1>MPDC Stakeholder CRM</h1>
      </div>
    </header>
  </div>
</div>

<script>

/* ---------------------------------------------------------
   SAFE AU DATE PARSER (dd/mm/yyyy ONLY)
   Fixes: 2027 bug, US parsing issues, future dates, invalids
--------------------------------------------------------- */

function parseDateSmart(str) {
  if (!str) return null;

  // Remove time, clean whitespace
  str = String(str).trim().split(" ")[0];

  // Expected format: dd/mm/yyyy
  const parts = str.split("/");
  if (parts.length !== 3) return null;

  let [day, month, year] = parts.map(x => parseInt(x, 10));

  if (!day || !month || !year) return null;

  // Reject year < 1000 or > 9999
  if (year < 1000 || year > 9999) return null;

  // Construct date explicitly (bypass browser parsing)
  const dt = new Date(year, month - 1, day);

  // Reject invalid constructed dates
  if (isNaN(dt.getTime())) return null;

  // Reject future dates (Option A)
  const today = new Date();
  today.setHours(0,0,0,0);
  if (dt > today) return null;

  return dt;
}


/* ---------------------------------------------------------
   FORMATTER — output: "11 Oct 2024"
--------------------------------------------------------- */

function fmtDate(v) {
  const dt = parseDateSmart(v);
  if (!dt) return "";   // Option A (blank if invalid)
  return dt.toLocaleDateString("en-AU", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}


/* ---------------------------------------------------------
   toISOorBlank stays the same
--------------------------------------------------------- */

function toISOorBlank(v){
  const d = parseDateSmart(v);
  return d ? d.toISOString() : null;
}

</script>
<!-- CONTINUATION OF YOUR ORIGINAL SCRIPT -->

<script>

// ================================
//  YOUR EXISTING JS CONTINUES HERE
//  (Unmodified — only date functions changed in Part 2)
// ================================

// Load CSV, parse rows, build RAW list
document.getElementById("csvFile").addEventListener("change", handleCSV, false);

function handleCSV(evt){
  const file = evt.target.files[0];
  if(!file) return;
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results){
      try{
        processRows(results.data);
      } catch(e){
        console.error(e);
        alert("There was an error while loading the CSV.");
      }
    }
  });
}

function processRows(rows){
  RAW = [];

  rows.forEach(r => {
    // CSV → Internal structure
    let o = {
      Name:          r[H.name] || "",
      Organisation:  r[H.organisation] || "",
      Role:          r[H.role] || "",
      Email:         r[H.email] || "",
      Phone:         r[H.phone] || "",
      Group:         r[H.groupPrimary] || r[H.groupLegacy] || "",
      SubGroup:      r[H.groupSub] || "",
      ProjectInterest: r[H.projectPrimary] || "",
      SubProject:    r[H.projectSub] || "",
      LatestInteractionDate: r[H.lastDate] || "",
      Subject:       r[H.lastSubj] || "",
      Notes:         r[H.notes] || "",
    };
    RAW.push(o);
  });

  renderAll();
}

// Basic filtering support
function passFilters(item){
  if(searchTerm){
    const t = searchTerm.toLowerCase();
    const blob = JSON.stringify(item).toLowerCase();
    if(!blob.includes(t)) return false;
  }
  if(selectedGroups.size){
    if(!selectedGroups.has(item.Group)) return false;
  }
  if(selectedProjects.size){
    if(!selectedProjects.has(item.ProjectInterest)) return false;
  }
  return true;
}

// Render all panels
function renderAll(){
  renderOrgs();
  renderContacts();
  renderInteractions();
}

/* -----------------------
   YOUR ORIGINAL FUNCTIONS
   (No changes below this line)
------------------------ */

function renderOrgs(){
  const tb = document.getElementById("orgs-body");
  tb.innerHTML = "";
  let count = 0;

  RAW.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.Organisation || ""}</td>
      <td>${item.Group || ""}</td>
      <td>${fmtDate(item.LatestInteractionDate)}</td>
    `;
    tb.appendChild(tr);
    count++;
  });

  document.getElementById("orgs-count").textContent = count;
}

function renderContacts(){
  const tb = document.getElementById("contacts-body");
  tb.innerHTML = "";
  let count = 0;

  RAW.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.Name || ""}</td>
      <td>${item.Organisation || ""}</td>
      <td>${item.Role || ""}</td>
      <td>${item.Email || ""}</td>
      <td>${item.Phone || ""}</td>
      <td>${item.Group || ""}</td>
      <td>${item.SubGroup || ""}</td>
      <td>${item.ProjectInterest || ""}</td>
      <td>${fmtDate(item.LatestInteractionDate)}</td>
      <td>${item.Subject || ""}</td>
    `;
    tb.appendChild(tr);
    count++;
  });

  document.getElementById("contacts-count").textContent = count;
}

function renderInteractions(){
  const tb = document.getElementById("ints-body");
  tb.innerHTML = "";
  let count = 0;

  RAW.forEach(item => {
    if(item.Subject || item.LatestInteractionDate){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.Name || ""}</td>
        <td>${fmtDate(item.LatestInteractionDate)}</td>
        <td>${item.Subject || ""}</td>
      `;
      tb.appendChild(tr);
      count++;
    }
  });

  document.getElementById("ints-count").textContent = count;
}


// Download JSON
document.getElementById("download-json").addEventListener("click", function(){
  const blob = new Blob([JSON.stringify({data: RAW}, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "data.json";
  a.click();
  URL.revokeObjectURL(url);
});

</script>


<!-- FOOTER (unchanged) -->

<footer class="foot-band">
  <div class="wrap">
    <p>MPDC Stakeholder CRM — Internal Use</p>
  </div>
</footer>

</body>
</html>
