<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MPDC Stakeholder CRM — Static Viewer</title>
  <!-- Tailwind CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Clean, uniform tables */
    .datawrap { overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; }
    .table-ish { width:100%; border-collapse:separate; border-spacing:0; min-width:1200px; }
    .table-ish thead th {
      position:sticky; top:0; z-index:10; background:#F9FAFB;
      border-bottom:1px solid #e5e7eb; padding:0.5rem; text-align:left;
      white-space:nowrap; font-weight:600; cursor:default;
    }
    .table-ish tbody td { border-bottom:1px solid #e5e7eb; padding:0.5rem; vertical-align:middle; }
    .table-ish tbody tr:last-child td { border-bottom:0; }
    .row:hover { background:#fafafa; }
    .cell { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }

    /* Column width hints (adjust anytime) */
    .w-name{ width:180px; }     /* smaller name */
    .w-org{ width:220px; }      /* keep visible */
    .w-group{ width:160px; }    /* keep visible */
    .w-role{ width:160px; }
    .w-email{ width:220px; }
    .w-phone{ width:140px; }
    .w-mpdc{ width:160px; }
    .w-last{ width:150px; }
    .w-subj{ width:220px; }
    .w-notes{ width:260px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-4">
      <div class="font-bold text-lg">MPDC Stakeholder CRM — Viewer (Static)</div>
      <nav class="ml-auto flex items-center gap-2 text-sm">
        <a href="#contacts" class="px-3 py-1 rounded hover:bg-gray-100">Contacts</a>
        <a href="#organisations" class="px-3 py-1 rounded hover:bg-gray-100">Organisations</a>
        <a href="#interactions" class="px-3 py-1 rounded hover:bg-gray-100">Interactions</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <section id="dashboard" class="mb-8">
      <div class="flex flex-col gap-3">
        <div>
          <h1 class="text-2xl font-semibold">Stakeholder overview</h1>
          <p class="text-sm text-gray-600">Read-only viewer that loads <code>data/data.json</code> (Netlify) with a safe embedded fallback below.</p>
        </div>
        <div class="flex items-center gap-2">
          <input id="search" class="border rounded px-3 py-2 w-72" placeholder="Search contacts, orgs, subjects…"/>
          <button id="exportBtn" class="px-3 py-2 rounded bg-gray-900 text-white">Export current JSON</button>
        </div>
      </div>
      <div id="summary" class="mt-4 grid grid-cols-1 gap-3"></div>
    </section>

    <!-- Contacts -->
    <section id="contacts" class="mb-10">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">Contacts</h2>
        <div class="flex items-center gap-2 text-sm">
          <button id="toggleContacts" class="px-3 py-1 rounded border">Expand list</button>
        </div>
      </div>
      <div id="contactsWrap" class="datawrap">
        <table id="contactsTable" class="table-ish">
          <thead>
            <tr>
              <th class="cell w-name"  data-sort="display_name">Name</th>
              <th class="cell w-org"   data-sort="org_name">Organisation</th>
              <th class="cell w-group" data-sort="group">Group</th>
              <th class="cell w-role"  data-sort="job_title">Role</th>
              <th class="cell w-email" data-sort="email">Email</th>
              <th class="cell w-phone" data-sort="phone">Phone</th>
              <th class="cell w-mpdc"  data-sort="mpdc_contact">MPDC contact</th>
              <th class="cell w-last"  data-sort="last_contact_at">Last contact</th>
              <th class="cell w-subj">Last subject</th>
              <th class="cell w-notes">Notes</th>
            </tr>
          </thead>
          <tbody id="contactsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Organisations -->
    <section id="organisations" class="mb-10">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">Organisations</h2>
        <div class="flex items-center gap-2 text-sm">
          <button id="toggleOrgs" class="px-3 py-1 rounded border">Expand list</button>
        </div>
      </div>
      <div id="orgsWrap" class="datawrap">
        <table id="orgsTable" class="table-ish">
          <thead>
            <tr>
              <th class="cell" data-sort="name">Organisation</th>
              <th class="cell" data-sort="contact_count">Contacts</th>
              <th class="cell" data-sort="last_contact_at">Last contact</th>
              <th class="cell">Recent topics</th>
            </tr>
          </thead>
          <tbody id="orgsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Interactions -->
    <section id="interactions" class="mb-10">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">Interactions</h2>
        <div class="flex items-center gap-2 text-sm">
          <button id="toggleInts" class="px-3 py-1 rounded border">Expand list</button>
        </div>
      </div>
      <div id="intsWrap" class="datawrap">
        <table id="intsTable" class="table-ish">
          <thead>
            <tr>
              <th class="cell" data-sort="occurred_at">Date</th>
              <th class="cell">Contact</th>
              <th class="cell">Subject</th>
              <th class="cell">Summary</th>
              <th class="cell" data-sort="type">Type</th>
            </tr>
          </thead>
          <tbody id="intsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Fallback sample data (used only if /data/data.json is missing) -->
  <script id="sample-data" type="application/json">{
    "organisations": [
      {"id": "o1", "name": "TasWater", "region": "Hobart"},
      {"id": "o2", "name": "TasPorts", "region": "Hobart"}
    ],
    "contacts": [
      {"id": "c1", "first_name": "Jane", "last_name": "Smith", "email": "jane.smith@taswater.com", "organisation_id": "o1", "group":"Utilities"},
      {"id": "c2", "first_name": "Mark", "last_name": "Brown", "email": "mark.brown@tasports.com", "organisation_id": "o2", "group":"Ports"}
    ],
    "interactions": [
      {"id": "i1", "contact_id": "c1", "occurred_at": "2025-09-10T01:00:00Z", "type": "email_in", "subject": "District Infrastructure Scheme – coordination", "summary": "Discussed staging and utilities interfaces."},
      {"id": "i2", "contact_id": "c2", "occurred_at": "2025-09-14T03:30:00Z", "type": "meeting",  "subject": "Northern Access Road – traffic management", "summary": "Detours and comms timeline."}
    ]
  }</script>

  <script>
    'use strict';
    // Tiny error box so blank pages never hide errors
    (function(){
      const box = document.createElement('div');
      box.id = 'errbox';
      box.style.cssText = 'position:fixed;bottom:12px;right:12px;max-width:520px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.2);font:12px ui-sans-serif,system-ui;display:none;z-index:9999;white-space:pre-wrap;';
      document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(box));
      function show(msg){ box.style.display='block'; box.textContent = msg; }
      window.addEventListener('error', e=> show('JS error: '+ (e.message||'') ));
    })();

    // Helpers
    const $ = sel => document.querySelector(sel);
    const fmtDate = iso => iso ? new Date(iso).toLocaleString() : '';
    const safe = s => (s??'').toString();
    const trunc = (s, n = 120) => { const t = safe(s); return t.length > n ? t.slice(0, n-1) + '…' : t; };

    // State
    let state = { organisations: [], contacts: [], interactions: [] };
    let filtered = { contacts: [], organisations: [], interactions: [] };
    let expand = { contacts: false, organisations: false, interactions: false };
    const LIMIT = { contacts: 50, organisations: 50, interactions: 100 };

    async function loadData() {
      try {
        const resp = await fetch('data/data.json', { cache: 'no-store' });
        if (resp.ok) {
          const json = await resp.json();
          if (json && (Array.isArray(json.contacts) || Array.isArray(json.organisations))) return json;
        }
      } catch (e) { /* fall back below */ }
      try { return JSON.parse(document.getElementById('sample-data').textContent); }
      catch { return {organisations:[],contacts:[],interactions:[]}; }
    }

    function derive(st) {
      const orgMap = new Map((st.organisations||[]).map(o => [o.id, o]));
      const contactMap = new Map((st.contacts||[]).map(c => [c.id, c]));

      // Last contact per contact from interactions
      const intsByContact = new Map();
      (st.interactions||[]).forEach(i => {
        if (!i || !i.contact_id) return;
        (intsByContact.get(i.contact_id) || intsByContact.set(i.contact_id, []).get(i.contact_id)).push(i);
      });
      (st.contacts||[]).forEach(c => {
        const list = (intsByContact.get(c.id) || []).sort((a,b)=>new Date(b.occurred_at)-new Date(a.occurred_at));
        c.last_contact_at = list[0]?.occurred_at || c.latest_interaction_at || c.latest_interaction_date || null;
        c.last_subject = list[0]?.subject || c.latest_interaction_subject || c.latest_interaction_summary || '';
        c.org_name = orgMap.get(c.organisation_id)?.name || c.organisation || '';
        c.display_name = [c.first_name, c.last_name].filter(Boolean).join(' ').trim() || c.name || '';
        c.group = c.group || c.group_name || c.category || c.segment || c.department || c.team || '';
      });

      // Per-organisation aggregates
      const intsByOrg = new Map();
      (st.interactions||[]).forEach(i => {
        const contact = contactMap.get(i.contact_id);
        const orgId = contact?.organisation_id;
        if (!orgId) return;
        (intsByOrg.get(orgId) || intsByOrg.set(orgId, []).get(orgId)).push(i);
      });
      (st.organisations||[]).forEach(o => {
        const list = (intsByOrg.get(o.id) || []).sort((a,b)=>new Date(b.occurred_at)-new Date(a.occurred_at));
        o.last_contact_at = list[0]?.occurred_at || null;
        o.contact_count = (st.contacts||[]).filter(c=>c.organisation_id===o.id).length;
        const recentSubjects = list.slice(0,6).map(i=>i.subject||'').join(' ');
        const tokens = recentSubjects.toLowerCase().split(/[^a-z0-9]+/).filter(x=>x && x.length>3);
        const freq = {}; tokens.forEach(t=>freq[t]=(freq[t]||0)+1);
        o.topics = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,4).map(([w])=>w);
      });
    }

    function renderSummary() {
      const totalContacts = (state.contacts||[]).length;
      const totalOrgs = (state.organisations||[]).length;
      const last7 = (state.interactions||[]).filter(i => (Date.now() - new Date(i.occurred_at)) < 7*864e5).length;
      $('#summary').innerHTML = `
        <div class="p-4 bg-white border rounded-lg"><div class="text-sm text-gray-600">Contacts</div><div class="text-2xl font-semibold">${totalContacts}</div></div>
        <div class="p-4 bg-white border rounded-lg"><div class="text-sm text-gray-600">Organisations</div><div class="text-2xl font-semibold">${totalOrgs}</div></div>
        <div class="p-4 bg-white border rounded-lg"><div class="text-sm text-gray-600">Interactions (7 days)</div><div class="text-2xl font-semibold">${last7}</div></div>`;
    }

    function renderContacts(rowsSrc) {
      const list = rowsSrc || [];
      const wrap = $('#contactsWrap'); if (wrap) wrap.style.maxHeight = expand.contacts ? '' : '28rem';
      const visible = expand.contacts ? list : list.slice(0, LIMIT.contacts);
      const rows = visible.map(c=>`
        <tr class="row cursor-pointer" data-id="${safe(c.id)}">
          <td class="cell w-name"  title="${safe(c.display_name)}">${safe(c.display_name)}</td>
          <td class="cell w-org"   title="${safe(c.org_name)}">${safe(c.org_name)}</td>
          <td class="cell w-group" title="${safe(c.group)}">${safe(c.group)}</td>
          <td class="cell w-role"  title="${safe(c.job_title)}">${safe(c.job_title)}</td>
          <td class="cell w-email" title="${safe(c.email)}"><a class="text-blue-600 hover:underline" href="mailto:${safe(c.email)}">${safe(c.email)}</a></td>
          <td class="cell w-phone" title="${safe(c.phone)}">${safe(c.phone)}</td>
          <td class="cell w-mpdc"  title="${safe(c.mpdc_contact)}">${safe(c.mpdc_contact)}</td>
          <td class="cell w-last"  title="${c.last_contact_at ? fmtDate(c.last_contact_at) : ''}">${c.last_contact_at ? fmtDate(c.last_contact_at) : '—'}</td>
          <td class="cell w-subj"  title="${safe(c.last_subject)}">${safe(c.last_subject)}</td>
          <td class="cell w-notes" title="${safe(c.notes)}">${safe(c.notes)}</td>
        </tr>`).join('');
      const body = document.getElementById('contactsBody');
      if (body) body.innerHTML = rows || `<tr><td class="p-3 text-center text-gray-500" colspan="10">No contacts</td></tr>`;
    }

    function renderOrgs(rowsSrc) {
      const list = rowsSrc || [];
      const wrap = $('#orgsWrap'); if (wrap) wrap.style.maxHeight = expand.organisations ? '' : '28rem';
      const visible = expand.organisations ? list : list.slice(0, LIMIT.organisations);
      const rows = visible.map(o=>`
        <tr class="row">
          <td class="cell" title="${safe(o.name)}">${safe(o.name)}</td>
          <td class="cell" title="${o.contact_count||0}">${o.contact_count||0}</td>
          <td class="cell" title="${o.last_contact_at ? fmtDate(o.last_contact_at) : ''}">${o.last_contact_at ? fmtDate(o.last_contact_at) : '—'}</td>
          <td class="cell">${(o.topics||[]).map(t=>`<span class="inline-block px-2 py-0.5 text-xs rounded-full bg-gray-100">${t}</span>`).join(' ')}</td>
        </tr>`).join('');
      const body = document.getElementById('orgsBody');
      if (body) body.innerHTML = rows || `<tr><td class="p-3 text-center text-gray-500" colspan="4">No organisations</td></tr>`;
    }

    function renderInts(rowsSrc) {
      const list = rowsSrc || [];
      const wrap = $('#intsWrap'); if (wrap) wrap.style.maxHeight = expand.interactions ? '' : '28rem';
      const visible = expand.interactions ? list : list.slice(0, LIMIT.interactions);
      const contactMap = new Map((state.contacts||[]).map(c => [c.id, c]));
      const rows = visible.map(i=>{
        const c = contactMap.get(i.contact_id);
        const who = c ? safe(c.display_name) : '';
        return `
        <tr class="row">
          <td class="cell" title="${i.occurred_at ? fmtDate(i.occurred_at) : ''}">${fmtDate(i.occurred_at)}</td>
          <td class="cell" title="${who}">${who}</td>
          <td class="cell" title="${safe(i.subject)}">${safe(i.subject)}</td>
          <td class="cell" title="${safe(i.summary)}">${safe(i.summary)}</td>
          <td class="cell" title="${safe(i.type)}">${safe(i.type)}</td>
        </tr>`;
      }).join('');
      const body = document.getElementById('intsBody');
      if (body) body.innerHTML = rows || `<tr><td class="p-3 text-center text-gray-500" colspan="5">No interactions</td></tr>`;
    }

    function applySearch(q) {
      const needle = (q||'').trim().toLowerCase();
      if (!needle) {
        filtered.contacts = [...(state.contacts||[])];
        filtered.organisations = [...(state.organisations||[])];
        filtered.interactions = [...(state.interactions||[])];
        return;
      }
      const inContact = c => [c.display_name, c.email, c.org_name, c.group, c.job_title, c.mpdc_contact, c.notes].some(v=>safe(v).toLowerCase().includes(needle));
      filtered.contacts = (state.contacts||[]).filter(inContact);
      filtered.organisations = (state.organisations||[]).filter(o=> safe(o.name).toLowerCase().includes(needle));
      filtered.interactions = (state.interactions||[]).filter(i=>{
        const c = (state.contacts||[]).find(x=>x.id===i.contact_id);
        return [i.subject, i.summary, c?.display_name, c?.email].some(v=>safe(v).toLowerCase().includes(needle));
      });
    }

    function renderAll() {
      renderSummary();
      renderContacts(filtered.contacts || []);
      renderOrgs(filtered.organisations || []);
      renderInts(filtered.interactions.sort((a,b)=>new Date(b.occurred_at)-new Date(a.occurred_at)) || []);
      // toggle labels
      const b1 = document.getElementById('toggleContacts'); if (b1) b1.textContent = expand.contacts ? 'Collapse list' : 'Expand list';
      const b2 = document.getElementById('toggleOrgs');     if (b2) b2.textContent = expand.organisations ? 'Collapse list' : 'Expand list';
      const b3 = document.getElementById('toggleInts');     if (b3) b3.textContent = expand.interactions ? 'Collapse list' : 'Expand list';
    }

    function exportJSON() {
      const blob = new Blob([JSON.stringify({
        organisations: state.organisations,
        contacts: state.contacts,
        interactions: state.interactions
      }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'data.json'; a.click(); URL.revokeObjectURL(url);
    }

    // Sorting (by clicking table headers with a data-sort attr)
    function makeSortable(tableId, accessor) {
      const thead = document.querySelector(`#${tableId} thead`);
      if (!thead) return;
      let dir = 1; let key = null;
      thead.addEventListener('click', e => {
        const th = e.target.closest('th'); if (!th || !th.dataset.sort) return;
        const newKey = th.dataset.sort; dir = key === newKey ? -dir : 1; key = newKey;
        const arr = accessor() || [];
        arr.sort((a,b)=>{
          if (['last_contact_at','occurred_at'].includes(key)) return (new Date(a[key]) - new Date(b[key])) * dir;
          const av = safe(a[key] ?? '').toLowerCase();
          const bv = safe(b[key] ?? '').toLowerCase();
          if (av>bv) return dir; if (av<bv) return -dir; return 0;
        });
        if (tableId==='contactsTable') renderContacts(arr);
        if (tableId==='orgsTable')     renderOrgs(arr);
        if (tableId==='intsTable')     renderInts(arr);
      });
    }

    // Init
    (async function init(){
      try {
        state = await loadData();
        derive(state);
        filtered.contacts = [...(state.contacts||[])];
        filtered.organisations = [...(state.organisations||[])];
        filtered.interactions = [...(state.interactions||[])];
        renderAll();

        // Search & export
        document.getElementById('search')?.addEventListener('input', (e)=>{ applySearch(e.target.value); renderAll(); });
        document.getElementById('exportBtn')?.addEventListener('click', exportJSON);

        // Sorting hooks
        makeSortable('contactsTable', ()=>filtered.contacts);
        makeSortable('orgsTable',     ()=>filtered.organisations);
        makeSortable('intsTable',     ()=>filtered.interactions);

        // Expand/Collapse toggles
        document.getElementById('toggleContacts')?.addEventListener('click', ()=>{ expand.contacts=!expand.contacts; renderAll(); });
        document.getElementById('toggleOrgs')?.addEventListener('click',     ()=>{ expand.organisations=!expand.organisations; renderAll(); });
        document.getElementById('toggleInts')?.addEventListener('click',     ()=>{ expand.interactions=!expand.interactions; renderAll(); });
      } catch (e) {
        const box = document.getElementById('errbox'); if (box) { box.style.display='block'; box.textContent = 'Init error: '+ (e.message||e); }
        console.error(e);
      }
    })();
  </script>
</body>
</html>
