// Helper: set wrap height to exactly N rows + header so ~20 rows visible
function adjustWrapHeight(wrapId, tableId, rowsToShow) {
  const wrap  = document.getElementById(wrapId);
  const table = document.getElementById(tableId);
  if (!wrap || !table) return;

  // measure header + a typical row
  const thead = table.querySelector('thead');
  const headH = thead ? thead.offsetHeight : 40;
  const firstRow = table.querySelector('tbody tr');
  const rowH = firstRow ? firstRow.offsetHeight : 40;

  wrap.style.maxHeight = (headH + rowH * rowsToShow) + 'px';
}

// Collapsed caps stay at 5; expanded shows internal scroll with ~20 rows visible
const ROWS_WHEN_COLLAPSED = 5;
const ROWS_VISIBLE_EXPANDED = 20;

function renderContacts(rowsSrc) {
  const list = rowsSrc || [];
  const wrap = document.getElementById('contactsWrap');

  // collapsed: only first 5 rows; expanded: render all rows, but fix container height to ~20 rows
  const visible = expand.contacts ? list : list.slice(0, ROWS_WHEN_COLLAPSED);

  const rows = visible.map(c=>`
    <tr class="row cursor-pointer" data-id="${(c.id ?? '')}">
      <td class="cell w-name"  title="${(c.display_name ?? '')}">${(c.display_name ?? '')}</td>
      <td class="cell w-org"   title="${(c.org_name ?? '')}">${(c.org_name ?? '')}</td>
      <td class="cell w-group" title="${(c.group ?? '')}">${(c.group ?? '')}</td>
      <td class="cell w-role"  title="${(c.job_title ?? '')}">${(c.job_title ?? '')}</td>
      <td class="cell w-email" title="${(c.email ?? '')}"><a class="text-blue-600 hover:underline" href="mailto:${(c.email ?? '')}">${(c.email ?? '')}</a></td>
      <td class="cell w-phone" title="${(c.phone ?? '')}">${(c.phone ?? '')}</td>
      <td class="cell w-mpdc"  title="${(c.mpdc_contact ?? '')}">${(c.mpdc_contact ?? '')}</td>
      <td class="cell w-last"  title="${c.last_contact_at ? fmtDate(c.last_contact_at) : ''}">${c.last_contact_at ? fmtDate(c.last_contact_at) : '—'}</td>
      <td class="cell w-subj"  title="${(c.last_subject ?? '')}">${(c.last_subject ?? '')}</td>
      <td class="cell w-notes" title="${(c.notes ?? '')}">${(c.notes ?? '')}</td>
    </tr>`).join('');

  const body = document.getElementById('contactsBody');
  if (body) body.innerHTML = rows || `<tr><td class="p-3 text-center text-gray-500" colspan="10">No contacts</td></tr>`;

  if (wrap) {
    if (expand.contacts) {
      // show internal scroller set to fit ~20 rows
      adjustWrapHeight('contactsWrap', 'contactsTable', ROWS_VISIBLE_EXPANDED);
    } else {
      // smaller collapsed container
      wrap.style.maxHeight = '12rem';
    }
  }
}

function renderOrgs(rowsSrc) {
  const list = rowsSrc || [];
  const wrap = document.getElementById('orgsWrap');
  const visible = expand.organisations ? list : list.slice(0, ROWS_WHEN_COLLAPSED);

  const rows = visible.map(o=>`
    <tr class="row">
      <td class="cell" title="${(o.name ?? '')}">${(o.name ?? '')}</td>
      <td class="cell" title="${(o.contact_count ?? 0)}">${(o.contact_count ?? 0)}</td>
      <td class="cell" title="${o.last_contact_at ? fmtDate(o.last_contact_at) : ''}">${o.last_contact_at ? fmtDate(o.last_contact_at) : '—'}</td>
      <td class="cell">${(o.topics||[]).map(t=>`<span class="inline-block px-2 py-0.5 text-xs rounded-full bg-gray-100">${t}</span>`).join(' ')}</td>
    </tr>`).join('');

  const body = document.getElementById('orgsBody');
  if (body) body.innerHTML = rows || `<tr><td class="p-3 text-center text-gray-500" colspan="4">No organisations</td></tr>`;

  if (wrap) {
    if (expand.organisations) {
      adjustWrapHeight('orgsWrap', 'orgsTable', ROWS_VISIBLE_EXPANDED);
    } else {
      wrap.style.maxHeight = '12rem';
    }
  }
}

function renderInts(rowsSrc) {
  const list = rowsSrc || [];
  const wrap = document.getElementById('intsWrap');
  const visible = expand.interactions ? list : list.slice(0, ROWS_WHEN_COLLAPSED);

  const contactMap = new Map((state.contacts||[]).map(c => [c.id, c]));
  const rows = visible.map(i=>{
    const c = contactMap.get(i.contact_id);
    const who = c ? (c.display_name ?? '') : '';
    return `
    <tr class="row">
      <td class="cell" title="${i.occurred_at ? fmtDate(i.occurred_at) : ''}">${fmtDate(i.occurred_at)}</td>
      <td class="cell" title="${who}">${who}</td>
      <td class="cell" title="${(i.subject ?? '')}">${(i.subject ?? '')}</td>
      <td class="cell" title="${(i.summary ?? '')}">${(i.summary ?? '')}</td>
      <td class="cell" title="${(i.type ?? '')}">${(i.type ?? '')}</td>
    </tr>`;
  }).join('');

  const body = document.getElementById('intsBody');
  if (body) body.innerHTML = rows || `<tr><td class="p-3 text-center text-gray-500" colspan="5">No interactions</td></tr>`;

  if (wrap) {
    if (expand.interactions) {
      adjustWrapHeight('intsWrap', 'intsTable', ROWS_VISIBLE_EXPANDED);
    } else {
      wrap.style.maxHeight = '12rem';
    }
  }
}
