<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MPDC Stakeholder CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7f9;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#1f79ff;
      --chip:#eef4ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    header{
      position:sticky;top:0;z-index:10;
      background:#0b315c;color:#fff;border-bottom:1px solid #062440;
    }
    header .wrap{
      max-width:1200px;margin:auto;display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 20px;
    }
    .title{font-weight:700;font-size:18px;letter-spacing:.2px}
    main{max-width:1200px;margin:18px auto;padding:0 20px 80px}
    .filters{
      display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px;
      background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;
    }
    .filter{display:flex;flex-direction:column;gap:6px}
    .filter label{font-size:12px;color:var(--muted)}
    select,input[type="text"]{
      appearance:none;width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;
      padding:10px 12px;font-size:14px;outline:none;
    }
    input[type="text"]{background:#fff}
    .results{
      margin-top:14px;background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;
    }
    table{width:100%;border-collapse:collapse}
    thead th{
      text-align:left;font-size:12px;color:var(--muted);font-weight:600;padding:12px;border-bottom:1px solid var(--line);background:#fafafa;
      white-space:nowrap;
    }
    tbody td{padding:12px;border-top:1px solid var(--line);vertical-align:top;font-size:14px}
    .name{font-weight:600}
    .subtle{color:var(--muted);font-size:12px}
    .pill{
      display:inline-block;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid #dbe7ff;font-size:12px;margin:2px 4px 2px 0
    }
    .btn{
      display:inline-block;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;
      text-decoration:none;color:var(--ink);font-size:13px
    }
    .btn:hover{border-color:#cad0d6}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .count{margin:10px 0 0 0;color:var(--muted);font-size:12px}
    @media (max-width:1000px){.filters{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:720px){.filters{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){
      .filters{grid-template-columns:1fr}
      thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody td{border:0;border-bottom:1px solid var(--line)}
      tbody tr{border-top:1px solid var(--line)}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">MPDC Stakeholder CRM – Contacts</div>
      <div class="subtle">Live data view</div>
    </div>
  </header>

  <main>
    <!-- Filters -->
    <section class="filters" aria-label="Filters">
      <!-- Keep naming as it was for Group -->
      <div class="filter">
        <label for="filterGroupPrimary">Group</label>
        <select id="filterGroupPrimary">
          <option>All</option>
        </select>
      </div>
      <div class="filter">
        <label for="filterGroupSub">Sub-Group</label>
        <select id="filterGroupSub">
          <option>All</option>
        </select>
      </div>

      <!-- New: Project filter, with similar look/feel -->
      <div class="filter">
        <label for="filterProjectPrimary">Project</label>
        <select id="filterProjectPrimary">
          <option>All</option>
        </select>
      </div>
      <div class="filter">
        <label for="filterProjectSub">Sub-Project</label>
        <select id="filterProjectSub">
          <option>All</option>
        </select>
      </div>

      <div class="filter" style="grid-column: span 2;">
        <label for="filterSearch">Search (name, org, email, role, group, project)</label>
        <input id="filterSearch" type="text" placeholder="Type to filter…" />
      </div>
    </section>

    <!-- Results -->
    <section class="results" aria-label="Contacts">
      <div class="count" id="resultCount" style="padding:10px 12px;">Loading…</div>
      <table>
        <thead>
          <tr>
            <th style="width:240px;">Contact</th>
            <th>Organisation</th>
            <th>Email / Phone</th>
            <th>Role</th>
            <!-- Show the four NEW columns (replace old Group/Project interest) -->
            <th>Group (Primary)</th>
            <th>Sub-Group</th>
            <th>Project Interest (Primary)</th>
            <th>Sub-Project</th>
          </tr>
        </thead>
        <tbody id="rows">
          <!-- injected -->
        </tbody>
      </table>
    </section>
  </main>

  <script>
    // ---------- Helpers for new schema (with spaces & parentheses) ----------
    const gp = r => (r && r["Group (Primary)"]) || "";
    const gs = r => (r && r["Sub-Group"]) || "";
    const pp = r => (r && r["Project Interest (Primary)"]) || "";
    const ps = r => (r && r["Sub-Project"]) || "";
    const org = r => (r && r["Organisation"]) || "";
    const phone = r => (r && (r["Phone number"] || r["Phone"])) || "";
    const nameOf = r => (r && r["Name"]) || "";
    const emailOf = r => (r && r["Email"]) || "";
    const roleOf = r => (r && r["Role"]) || "";
    const latestDate = r => (r && r["Latest Interaction Date"]) || "";
    const latestSubject = r => (r && r["Latest interaction subject"]) || "";

    function uniqueSorted(arr){return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));}

    // ---------- State ----------
    let data = [];
    const els = {
      groupPrimary: document.getElementById("filterGroupPrimary"),
      groupSub: document.getElementById("filterGroupSub"),
      projPrimary: document.getElementById("filterProjectPrimary"),
      projSub: document.getElementById("filterProjectSub"),
      search: document.getElementById("filterSearch"),
      rows: document.getElementById("rows"),
      count: document.getElementById("resultCount"),
    };

    // ---------- Populate selects ----------
    function fillSelect(select, options){
      select.innerHTML = options.map(o => `<option value="${o}">${o}</option>`).join("");
    }

    function buildPrimaries(){
      fillSelect(els.groupPrimary, ["All"].concat(uniqueSorted(data.map(gp))));
      fillSelect(els.projPrimary, ["All"].concat(uniqueSorted(data.map(pp))));
      // fire to populate subs
      els.groupPrimary.dispatchEvent(new Event("change"));
      els.projPrimary.dispatchEvent(new Event("change"));
    }

    els.groupPrimary.addEventListener("change", () => {
      const sel = els.groupPrimary.value;
      const subs = sel === "All"
        ? uniqueSorted(data.map(gs))
        : uniqueSorted(data.filter(r => gp(r) === sel).map(gs));
      fillSelect(els.groupSub, ["All"].concat(subs));
      render();
    });

    els.projPrimary.addEventListener("change", () => {
      const sel = els.projPrimary.value;
      const subs = sel === "All"
        ? uniqueSorted(data.map(ps))
        : uniqueSorted(data.filter(r => pp(r) === sel).map(ps));
      fillSelect(els.projSub, ["All"].concat(subs));
      render();
    });

    els.groupSub.addEventListener("change", render);
    els.projSub.addEventListener("change", render);
    els.search.addEventListener("input", () => {
      // light debounce
      clearTimeout(els.search._t);
      els.search._t = setTimeout(render, 120);
    });

    // ---------- Filtering ----------
    function recordMatches(r, q){
      if (q.gp !== "All" && gp(r) !== q.gp) return false;
      if (q.gs !== "All" && gs(r) !== q.gs) return false;
      if (q.pp !== "All" && pp(r) !== q.pp) return false;
      if (q.ps !== "All" && ps(r) !== q.ps) return false;

      if (q.txt){
        const hay = [
          nameOf(r), org(r), emailOf(r), phone(r), roleOf(r),
          gp(r), gs(r), pp(r), ps(r)
        ].join(" ").toLowerCase();
        if (!hay.includes(q.txt)) return false;
      }
      return true;
    }

    // ---------- Rendering ----------
    function escapeHtml(s){return String(s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

    function render(){
      const q = {
        gp: els.groupPrimary.value || "All",
        gs: els.groupSub.value || "All",
        pp: els.projPrimary.value || "All",
        ps: els.projSub.value || "All",
        txt: (els.search.value || "").trim().toLowerCase()
      };
      const rows = data.filter(r => recordMatches(r, q));

      els.count.textContent = `${rows.length.toLocaleString()} contact${rows.length===1?"":"s"} shown`;

      const html = rows.map(r => {
        const nm = escapeHtml(nameOf(r));
        const og = escapeHtml(org(r));
        const em = (emailOf(r) || "").trim();
        const ph = escapeHtml(phone(r));
        const rl = escapeHtml(roleOf(r));

        const gpr = escapeHtml(gp(r));
        const sgr = escapeHtml(gs(r));
        const ppr = escapeHtml(pp(r));
        const spr = escapeHtml(ps(r));

        const emailBtn = em ? `<a class="btn" href="mailto:${encodeURIComponent(em)}?subject=${encodeURIComponent('Hello from MPDC')}" title="Email ${nm}">Email</a>` : `<span class="subtle">No email</span>`;

        return `
          <tr>
            <td>
              <div class="name">${nm || "(No name)"}${rl ? ` <span class="subtle">· ${rl}</span>` : ""}</div>
              ${latestDate(r) || latestSubject(r) ? `<div class="subtle">Latest: ${escapeHtml(latestDate(r))}${latestSubject(r)?` – ${escapeHtml(latestSubject(r))}`:""}</div>`:""}
            </td>
            <td>${og || "<span class='subtle'>(No organisation)</span>"}</td>
            <td>
              <div class="controls" style="margin-bottom:6px;">${emailBtn}</div>
              ${em ? `<div class="subtle">${escapeHtml(em)}</div>`:""}
              ${ph ? `<div class="subtle">${ph}</div>`:""}
            </td>
            <td>${rl || "<span class='subtle'>–</span>"}</td>
            <!-- NEW visible columns -->
            <td>${gpr || "<span class='subtle'>–</span>"}</td>
            <td>${sgr || "<span class='subtle'>–</span>"}</td>
            <td>${ppr || "<span class='subtle'>–</span>"}</td>
            <td>${spr || "<span class='subtle'>–</span>"}</td>
          </tr>
        `;
      }).join("");

      els.rows.innerHTML = html || `<tr><td colspan="8" class="subtle" style="padding:18px;">No results.</td></tr>`;
    }

    // ---------- Boot ----------
    (async function boot(){
      try{
        const res = await fetch("/data/data.json", {cache:"no-store"});
        if(!res.ok) throw new Error(`Fetch failed: ${res.status}`);
        const json = await res.json();
        // Accept array or object with .items
        data = Array.isArray(json) ? json : (json.items || []);
        // Build primaries and render
        buildPrimaries();
        render();
      }catch(err){
        els.count.textContent = "Failed to load data.";
        console.error(err);
      }
    })();
  </script>
</body>
</html>
