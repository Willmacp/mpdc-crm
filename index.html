<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MPDC Stakeholder CRM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ---------- GENERAL LAYOUT ---------- */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f4f4f4;
}
header {
    background: #003535;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
}

.container {
    padding: 20px;
}

/* ---------- TABLES ---------- */
table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 40px;
    background: white;
}
table thead {
    background: #d8ae52;
    color: #003535;
}
th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: left;
}

/* ---------- STATUS PILLS ---------- */
.pill {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-align: center;
}
.green { background: #2e8b57; }
.amber { background: #d8ae52; color: #003535; }
.red   { background: #aa0c38; }

/* ---------- FILTERS ---------- */
.filter-bar {
    margin: 20px 0;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}
select, input {
    padding: 8px;
    font-size: 14px;
}

.section-title {
    font-size: 20px;
    margin: 50px 0 10px;
    color: #003535;
}
</style>

</head>
<body>

<header>MPDC Stakeholder CRM</header>

<div class="container">

<!-- --------------------- FILTERS --------------------- -->
<div class="filter-bar">
    <input id="searchBox" type="text" placeholder="Search stakeholders…" onkeyup="applyFilters()" />

    <select id="groupFilter" onchange="applyFilters()">
        <option value="">Filter by Group</option>
    </select>

    <select id="projectFilter" onchange="applyFilters()">
        <option value="">Filter by Project</option>
    </select>
</div>

<!-- --------------------- CONTACTS --------------------- -->
<h2 class="section-title">Contacts</h2>

<table id="contactsTable">
<thead>
<tr>
    <th>Name</th>
    <th>Organisation</th>
    <th>Latest Interaction</th>
    <th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- --------------------- ORGANISATIONS --------------------- -->
<h2 class="section-title">Organisations</h2>

<table id="orgTable">
<thead>
<tr>
    <th>Organisation</th>
    <th>Latest Interaction</th>
    <th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- --------------------- INTERACTIONS --------------------- -->
<h2 class="section-title">Interactions</h2>

<table id="intTable">
<thead>
<tr>
    <th>Name</th>
    <th>Date</th>
    <th>Subject</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>

/* ----------------------------------------------------------
   SAFE DATE PARSER — AU FORMAT (11 Oct 2024) — NO DRIFT
---------------------------------------------------------- */

// Matches YYYY-MM-DD
function isISODateOnly(s){
    return /^\d{4}-\d{2}-\d{2}$/.test(s);
}

// Parse YYYY-MM-DD safely in UTC
function parseISODateOnly(s){
    const [y, m, d] = s.split('-').map(Number);
    return new Date(Date.UTC(y, m - 1, d));
}

function parseDateSmart(input){
    if(!input) return null;
    const s = String(input).trim();

    // YYYY-MM-DD
    if(isISODateOnly(s)){
        return parseISODateOnly(s);
    }

    // Full ISO with time
    if(/^\d{4}-\d{2}-\d{2}T/.test(s)){
        const dt = new Date(s);
        return isNaN(dt) ? null : dt;
    }

    // AU/US fallback
    const parts = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if(parts){
        let a = parseInt(parts[1]);
        let b = parseInt(parts[2]);
        let y = parseInt(parts[3]);
        if(y < 100) y += 2000;

        // AU DD/MM/YYYY
        if(a > 12 && b <= 12){
            return new Date(Date.UTC(y, b - 1, a));
        }
        // US MM/DD/YYYY
        return new Date(Date.UTC(y, a - 1, b));
    }

    // Final fallback
    const loose = new Date(s);
    return isNaN(loose) ? null : loose;
}

// Format: 11 Oct 2024
function fmtDate(v){
    const d = parseDateSmart(v);
    if(!d) return '';

    const day = d.getUTCDate();
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const month = monthNames[d.getUTCMonth()];
    const year = d.getUTCFullYear();

    return `${day} ${month} ${year}`;
}

/* ----------------------------------------------------------
   LOAD JSON
---------------------------------------------------------- */

let CRM_DATA = [];

fetch("data/data.json")
  .then(r => r.json())
  .then(data => {
      CRM_DATA = data;
      populateFilters(data);
      renderTables(data);
  });

/* ----------------------------------------------------------
   POPULATE FILTERS
---------------------------------------------------------- */
function populateFilters(data){
    const groups = [...new Set(data.map(x => x.Group).filter(Boolean))].sort();
    const projects = [...new Set(data.map(x => x.ProjectInterest).filter(Boolean))].sort();

    let g = document.getElementById("groupFilter");
    groups.forEach(v => {
        let o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        g.appendChild(o);
    });

    let p = document.getElementById("projectFilter");
    projects.forEach(v => {
        let o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        p.appendChild(o);
    });
}

/* ----------------------------------------------------------
   STATUS PILL BASED ON LATESTINTERACTIONDATE
---------------------------------------------------------- */
function statusPill(dateStr){
    const d = parseDateSmart(dateStr);
    if(!d) return '<span class="pill red">No date</span>';

    const now = new Date();
    const diff = Math.floor((now - d) / (1000*60*60*24));

    if(diff <= 30) return `<span class="pill green">${diff}d</span>`;
    if(diff <= 60) return `<span class="pill amber">${diff}d</span>`;
    return `<span class="pill red">${diff}d</span>`;
}

/* ----------------------------------------------------------
   RENDER TABLES
---------------------------------------------------------- */
function renderTables(data){
    renderContacts(data);
    renderOrgs(data);
    renderInteractions(data);
}

function renderContacts(data){
    const tbody = document.querySelector("#contactsTable tbody");
    tbody.innerHTML = "";

    data.forEach(item => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.Name || ""}</td>
          <td>${item.Organisation || ""}</td>
          <td>${fmtDate(item.LatestInteractionDate)}</td>
          <td>${statusPill(item.LatestInteractionDate)}</td>
        `;
        tbody.appendChild(tr);
    });
}

function renderOrgs(data){
    const tbody = document.querySelector("#orgTable tbody");
    tbody.innerHTML = "";

    const orgMap = {};

    data.forEach(item => {
        const org = item.Organisation || "Unknown";
        const d = parseDateSmart(item.LatestInteractionDate);
        if(!orgMap[org] || d > orgMap[org].date){
            orgMap[org] = {date: d, raw: item.LatestInteractionDate};
        }
    });

    Object.keys(orgMap).sort().forEach(org => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${org}</td>
          <td>${fmtDate(orgMap[org].raw)}</td>
          <td>${statusPill(orgMap[org].raw)}</td>
        `;
        tbody.appendChild(tr);
    });
}

function renderInteractions(data){
    const tbody = document.querySelector("#intTable tbody");
    tbody.innerHTML = "";

    data
      .filter(x => x.Subject || x.LatestInteractionDate)
      .sort((a,b) => {
         const da = parseDateSmart(a.LatestInteractionDate);
         const db = parseDateSmart(b.LatestInteractionDate);
         return db - da;
      })
      .forEach(item => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.Name || ""}</td>
          <td>${fmtDate(item.LatestInteractionDate)}</td>
          <td>${item.Subject || ""}</td>
        `;
        tbody.appendChild(tr);
      });
}

/* ----------------------------------------------------------
   FILTERS
---------------------------------------------------------- */
function applyFilters(){
    const search = document.getElementById("searchBox").value.toLowerCase();
    const group = document.getElementById("groupFilter").value;
    const proj = document.getElementById("projectFilter").value;

    const filtered = CRM_DATA.filter(item => {
        const matchesSearch =
            (item.Name || "").toLowerCase().includes(search) ||
            (item.Organisation || "").toLowerCase().includes(search);

        const matchesGroup = !group || item.Group === group;
        const matchesProj  = !proj  || item.ProjectInterest === proj;

        return matchesSearch && matchesGroup && matchesProj;
    });

    renderTables(filtered);
}

</script>

</body>
</html>
