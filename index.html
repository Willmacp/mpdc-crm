<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MPDC Stakeholder CRM</title>
  <style>
    :root{
      --accent:#5f809b; /* MPDC blue accent */
      --grey:#6d6e71;   /* MPDC grey */
      --bg:#f7f8fa;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --head:#f3f5f8;
      --shadow:0 1px 2px rgba(0,0,0,.05);
      --chip:#eef2f7;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    header{display:flex;flex-wrap:wrap;gap:10px 14px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .brand{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7899b2)}
    h1{font-size:22px;margin:0}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:#334155;font-size:12px}
    .chip.ok{background:#e9f8ef;color:#155e2e;border-color:#b7ebc2}
    .stamp{font-size:12px;color:var(--muted)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px;box-shadow:var(--shadow)}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .search{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 10px;box-shadow:var(--shadow);min-width:260px}
    .search input{border:none;outline:none;font-size:14px;flex:1;background:transparent}
    .search .clear{border:none;background:transparent;cursor:pointer;color:#64748b}

    /* Group filter bar */
    .filters{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .filters .label{font-size:13px;color:#475569}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;box-shadow:var(--shadow);font-size:12px;cursor:pointer;user-select:none}
    .tag .count{color:var(--muted)}
    .tag.selected{background:var(--accent);color:#fff;border-color:transparent}
    .filters .clear{font-size:12px;color:#5f809b;text-decoration:none;margin-left:4px}

    main{display:flex;flex-direction:column;gap:16px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow)}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
    .card-head h2{margin:0;font-size:18px}
    .card-head h2 .count{color:var(--muted);font-weight:500;margin-left:8px}
    .card-body{padding:0}
    .table-wrap{overflow:auto;max-height:420px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:1000px}
    thead th{position:sticky;top:0;background:var(--head);z-index:1;font-weight:600}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    tr:nth-child(even) td{background:#fafbfc}
    .muted{color:var(--muted)}
    footer{margin:28px 0 40px;color:var(--grey);display:flex;justify-content:space-between;align-items:center;font-size:13px}
    a.top{color:var(--accent);text-decoration:none}
    a.mail{color:#0b65c2;text-decoration:none}
    a.mail:hover{text-decoration:underline}

    /* column widths */
    .w-name{max-width:220px}
    .w-org{max-width:220px}
    .w-group{max-width:240px}
    .w-role{max-width:160px}
    .w-email{max-width:240px}
    .w-phone{max-width:140px}
    .w-mpdc{max-width:200px}
    .w-date{max-width:140px}
    .w-subj{max-width:260px}
    .w-notes{max-width:320px}

    .card-head h2::before{
      content:"";
      display:inline-block;width:8px;height:8px;border-radius:50%;
      background:var(--accent);margin-right:10px;vertical-align:middle;
    }

    /* Export panel */
    .panel{position:relative;display:inline-block}
    .panel .pop{
      position:absolute;right:0;top:44px;min-width:280px;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);
      padding:12px 12px;z-index:10;display:none;
    }
    .panel.open .pop{display:block}
    .pop h4{margin:4px 0 10px;font-size:14px}
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:6px 10px;margin-top:8px}
    .pop .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .pop small{color:var(--muted)}
    .pop label{font-size:13px}

    /* Organisations expandable rows */
    #tb-orgs tr[data-org]{cursor:pointer}
    #tb-orgs tr[data-org]:hover td{background:#f1f5f9}
    tr.org-expander td{background:#fbfdff}
    .org-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#fff;
      box-shadow:var(--shadow);
    }
    .org-card h3{margin:0 0 8px 0;font-size:16px}
    .org-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px}
    .org-person{display:flex;flex-wrap:wrap;gap:6px 10px;align-items:center;border:1px dashed #e2e8f0;border-radius:10px;padding:8px}
    .org-person .nm{font-weight:600}
    .org-person .role{color:var(--muted)}
    .org-person .sep{color:#cbd5e1}
    .org-actions{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}

    /* Contact hover card */
    .hovercard{
      position:fixed; z-index:1000; display:none;
      background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.12);
      padding:12px; max-width:420px; width:max-content; min-width:300px;
    }
    .hovercard h3{margin:0 24px 6px 0; font-size:16px}
    .hovercard .close{
      position:absolute; top:8px; right:8px; border:none; background:transparent; cursor:pointer; font-size:16px; color:#64748b
    }
    .hovergrid{display:grid; grid-template-columns:auto 1fr; gap:6px 12px; align-items:center}
    .hovergrid .lab{color:var(--muted)}
    .hovergroups{display:flex; flex-wrap:wrap; gap:6px 6px}
    .row-hoverable{cursor:default}
    @media (max-width:720px){
      .hovercard{max-width:95vw; min-width:260px}
      .org-grid{grid-template-columns:1fr}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>MPDC Stakeholder CRM</h1>
        <div class="meta">
          <span id="chip" class="chip">Data: loadingâ€¦</span>
          <span id="lastStamp" class="stamp">Last updated: â€”</span>
        </div>
      </div>

      <div class="toolbar">
        <div class="search" title="Type to filter contacts/organisations">
          <span>ðŸ”Ž</span>
          <input id="searchBox" type="search" placeholder="Search name, org, email, groupâ€¦" />
          <button id="btnClearSearch" class="clear" title="Clear search">âœ•</button>
        </div>
        <button class="btn" id="btnReload" title="Reload remote JSON">Reload data</button>
        <button class="btn" id="btnLoadCsv">Load CSV</button>
        <button class="btn" id="btnLoadJson">Load JSON</button>

        <div class="panel" id="exportPanel">
          <button class="btn" id="btnExportCsv">Export CSV â–¾</button>
          <div class="pop">
            <h4>Export CSV</h4>
            <div class="row"><label><input type="radio" name="exportScope" value="filtered" checked/> Filtered (current view)</label></div>
            <div class="row"><label><input type="radio" name="exportScope" value="all" /> All contacts</label></div>
            <div class="row"><small>Select columns:</small></div>
            <div class="cols" id="colChecks"></div>
            <div class="actions">
              <button class="btn" id="btnCancelExport">Cancel</button>
              <button class="btn primary" id="btnDoExport">Export</button>
            </div>
          </div>
        </div>

        <button class="btn" id="btnDlJson">Export JSON</button>
      </div>

      <input type="file" id="fileCsv" accept=".csv,text/csv" hidden />
      <input type="file" id="fileJson" accept=".json,application/json" hidden />
    </header>

    <!-- Group filter chips -->
    <div class="filters" id="groupFilters" aria-label="Filter by group">
      <span class="label">Groups:</span>
      <a href="#" class="clear" id="clearGroups">Clear</a>
    </div>

    <main>
      <!-- CONTACTS -->
      <section class="card" id="sec-contacts">
        <div class="card-head">
          <h2>Contacts <span class="count" id="countContacts"></span></h2>
          <button class="btn" id="expContacts">Expand list</button>
        </div>
        <div class="card-body">
          <div class="table-wrap" id="tw-contacts">
            <table>
              <thead>
                <tr>
                  <th class="w-name">Name</th>
                  <th class="w-org">Organisation</th>
                  <th class="w-group">Group</th>
                  <th class="w-role">Role</th>
                  <th class="w-email">Email</th>
                  <th class="w-phone">Phone</th>
                  <th class="w-mpdc">MPDC contact</th>
                  <th class="w-date">Last contact</th>
                  <th class="w-subj">Last subject</th>
                  <th class="w-notes">Notes</th>
                </tr>
              </thead>
              <tbody id="tb-contacts"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ORGANISATIONS -->
      <section class="card" id="sec-orgs">
        <div class="card-head">
          <h2>Organisations <span class="count" id="countOrgs"></span></h2>
          <button class="btn" id="expOrgs">Expand list</button>
        </div>
        <div class="card-body">
          <div class="table-wrap" id="tw-orgs">
            <table>
              <thead>
                <tr>
                  <th class="w-org">Organisation</th>
                  <th>Contacts</th>
                  <th class="w-date">Last contact</th>
                  <th class="w-subj">Recent topics</th>
                </tr>
              </thead>
              <tbody id="tb-orgs"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- INTERACTIONS -->
      <section class="card" id="sec-ints">
        <div class="card-head">
          <h2>Interactions <span class="count" id="countInts"></span></h2>
          <button class="btn" id="expInts">Expand list</button>
        </div>
        <div class="card-body">
          <div class="table-wrap" id="tw-ints">
            <table>
              <thead>
                <tr>
                  <th class="w-date">Date</th>
                  <th class="w-name">Contact</th>
                  <th class="w-subj">Subject</th>
                  <th>Summary</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody id="tb-ints"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <span>MPDC Stakeholder CRM â€” please talk to the Comms team for assistance or to suggest edits</span>
      <a href="#" class="top" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">Back to top â†‘</a>
    </footer>
  </div>

  <!-- Floating hover card for Contacts -->
  <div class="hovercard" id="hoverCard" role="dialog" aria-modal="false">
    <button class="close" id="hoverClose" aria-label="Close">âœ•</button>
    <h3 id="hcName">(Name)</h3>
    <div class="hovergrid">
      <div class="lab">Organisation</div><div id="hcOrg">â€”</div>
      <div class="lab">Role</div><div id="hcRole">â€”</div>
      <div class="lab">Email</div><div id="hcEmail">â€”</div>
      <div class="lab">Phone</div><div id="hcPhone">â€”</div>
      <div class="lab">MPDC</div><div id="hcMpdc">â€”</div>
      <div class="lab">Groups</div><div class="hovergroups" id="hcGroups"></div>
      <div class="lab">Last contact</div><div id="hcDate">â€”</div>
      <div class="lab">Last subject</div><div id="hcSubject">â€”</div>
      <div class="lab">Notes</div><div id="hcNotes">â€”</div>
    </div>
  </div>

<script>
(function(){
  const DATA_URL = '/data/data.json';
  const ORG_CONTACTS_PREVIEW = 3;

  const chip = document.getElementById('chip');
  const lastStamp = document.getElementById('lastStamp');
  const btnReload = document.getElementById('btnReload');

  const searchBox = document.getElementById('searchBox');
  const btnClearSearch = document.getElementById('btnClearSearch');

  const countContacts = document.getElementById('countContacts');
  const countOrgs = document.getElementById('countOrgs');
  const countInts = document.getElementById('countInts');

  // Export panel
  const exportPanel = document.getElementById('exportPanel');
  const btnExportCsv = document.getElementById('btnExportCsv');
  const btnCancelExport = document.getElementById('btnCancelExport');
  const btnDoExport = document.getElementById('btnDoExport');
  const colChecks = document.getElementById('colChecks');

  // Group filters UI
  const groupFilters = document.getElementById('groupFilters');
  const clearGroups = document.getElementById('clearGroups');

  // Hover card elements
  const hc = document.getElementById('hoverCard');
  const hcClose = document.getElementById('hoverClose');
  const HC = {
    name: document.getElementById('hcName'),
    org: document.getElementById('hcOrg'),
    role: document.getElementById('hcRole'),
    email: document.getElementById('hcEmail'),
    phone: document.getElementById('hcPhone'),
    mpdc: document.getElementById('hcMpdc'),
    groups: document.getElementById('hcGroups'),
    date: document.getElementById('hcDate'),
    subj: document.getElementById('hcSubject'),
    notes: document.getElementById('hcNotes'),
  };

  // State
  let st = { organisations: [], contacts: [], interactions: [], _meta: null };
  let limits = { contacts: 5, orgs: 5, ints: 5 };
  let search = '';
  let selectedGroups = new Set();
  let allGroups = [];
  let expandedOrgs = new Set();
  let contactsById = new Map();
  let hoverSticky = false; // when user clicks a row to pin the card

  const DEFAULT_COLUMNS = [
    {key:'display_name', label:'Name', checked:true},
    {key:'organisation', label:'Organisation', checked:true},
    {key:'group',        label:'Group', checked:true},
    {key:'job_title',    label:'Role', checked:false},
    {key:'email',        label:'Email', checked:true},
    {key:'phone',        label:'Phone', checked:true},
    {key:'mpdc_contact', label:'MPDC contact', checked:false},
    {key:'last_contact_at', label:'Last contact', checked:true},
    {key:'last_subject', label:'Last subject', checked:true},
    {key:'notes',        label:'Notes', checked:false},
  ];

  // Helpers
  const esc = s => (s??'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const by = (k, dir=1) => (a,b)=> (a[k]??'').toString().localeCompare((b[k]??'').toString(),undefined,{numeric:true,sensitivity:'base'})*dir;
  const fmtDate = s => {
    if(!s) return '';
    const d = new Date(s);
    return isNaN(d) ? (''+s) : d.toLocaleDateString();
  };
  const clean = v => (v??'').toString().trim();
  const toISOorBlank = v => { if(!v) return null; const d=new Date(v); return isNaN(d)?null:d.toISOString(); };
  const norm = v => clean(v).toLowerCase();

  function setLastUpdated(dt){
    if(!dt){ lastStamp.textContent = 'Last updated: â€”'; return; }
    const d = new Date(dt);
    try{ lastStamp.textContent = 'Last updated: ' + new Intl.DateTimeFormat(undefined,{dateStyle:'medium', timeStyle:'short'}).format(d); }
    catch(e){ lastStamp.textContent = 'Last updated: ' + d.toLocaleString(); }
  }

  // GROUP NORMALISATION
  function normalizeGroups(val){
    if(val == null) return [];
    if(Array.isArray(val)) return finaliseGroups(flattenArray(val));
    if(typeof val === 'object'){
      if(Array.isArray(val.results)) return finaliseGroups(flattenArray(val.results));
      if('Value' in val) return finaliseGroups([clean(String(val.Value))]);
      return fromString(String(val));
    }
    return fromString(String(val));
  }
  function fromString(s){
    s = String(s).trim(); if(!s) return [];
    s = s.replace(/[â€œâ€]/g,'"').replace(/[â€˜â€™]/g,"'");
    if((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) s = s.slice(1,-1).trim();
    if(/^\s*\[.*\]\s*$/.test(s)){
      const p = tryParseJsonArray(s);
      if(p) return finaliseGroups(flattenArray(p));
    }
    s = s.replace(/[\[\]]/g,'').replace(/["']/g,'');
    const parts = s.split(/[;,|]/).map(x=>x.trim()).filter(Boolean);
    return finaliseGroups(parts);
  }
  function tryParseJsonArray(s){
    try{ const a = JSON.parse(s); return Array.isArray(a)?a:null; }catch(_){}
    try{ const a = JSON.parse(s.replace(/'/g,'"')); return Array.isArray(a)?a:null; }catch(_){}
    try{ const a = JSON.parse(s.replace(/""/g,'"')); return Array.isArray(a)?a:null; }catch(_){}
    return null;
  }
  function flattenArray(arr){
    const out = [];
    for(const x of arr){
      if(x == null) continue;
      if(typeof x === 'string'){ out.push(clean(x)); continue; }
      if(typeof x === 'object'){
        if('Value' in x){ out.push(clean(String(x.Value))); continue; }
        if('value' in x){ out.push(clean(String(x.value))); continue; }
        if('Title' in x){ out.push(clean(String(x.Title))); continue; }
        if(Array.isArray(x.results)){ out.push(...x.results.map(v=>clean(String(v)))); continue; }
        out.push(clean(String(x).replace(/[\[\]"']/g,''))); continue;
      }
      out.push(clean(String(x)));
    }
    return out;
  }
  function finaliseGroups(parts){
    const seen = new Set(), kept = [];
    for(let v of parts){
      v = clean(v); if(!v) continue;
      const k = v.toLowerCase();
      if(!seen.has(k)){ seen.add(k); kept.push(v); }
    }
    return kept.sort((a,b)=> a.localeCompare(b, undefined, {sensitivity:'base'}));
  }

  // Derive organisations (skip blank orgs)
  function deriveOrgs(contacts){
    const m = new Map();
    for(const c of contacts){
      const orgRaw = clean(c.organisation);
      if(!orgRaw) continue;
      if(!m.has(orgRaw)) m.set(orgRaw,{ organisation: orgRaw, contact_names: [], last_contact_at: null, recent_topics: [] });
      const o = m.get(orgRaw);
      if(clean(c.display_name)) o.contact_names.push(c.display_name);
      if(c.last_contact_at){
        if(!o.last_contact_at || new Date(c.last_contact_at) > new Date(o.last_contact_at)){ o.last_contact_at = c.last_contact_at; }
      }
      if(clean(c.last_subject)) o.recent_topics.push(c.last_subject);
    }
    return Array.from(m.values()).map(o=>{
      const n = o.contact_names.length;
      const previewArr = o.contact_names.slice(0, ORG_CONTACTS_PREVIEW);
      let preview = previewArr.join(', ');
      if(n > ORG_CONTACTS_PREVIEW){ preview += ` â€¦(+${n - ORG_CONTACTS_PREVIEW})`; }
      return {
        organisation: o.organisation,
        contacts: o.contact_names.join(', '),
        contacts_preview: preview,
        contacts_count: n,
        last_contact_at: o.last_contact_at,
        recent_topics: Array.from(new Set(o.recent_topics.filter(Boolean))).slice(0,3).join(' â€¢ ')
      };
    });
  }

  // Build group index and chips
  function rebuildGroupIndex(){
    const counts = new Map(), display = new Map();
    for(const c of st.contacts){
      const gs = normalizeGroups(c.group);
      c.group = gs;
      for(const g of gs){
        const key = g.toLowerCase();
        counts.set(key, (counts.get(key)||0)+1);
        if(!display.has(key)) display.set(key, g);
      }
    }
    allGroups = Array.from(counts.entries())
      .map(([key,count])=>({ key, name: display.get(key), count }))
      .sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
    renderGroupChips();
  }
  function renderGroupChips(){
    while(groupFilters.children.length>2) groupFilters.removeChild(groupFilters.lastChild);
    allGroups.forEach(({key,name,count})=>{
      const b = document.createElement('button');
      b.type='button';
      b.className='tag';
      b.dataset.groupKey=key;
      b.innerHTML = `<span>${esc(name)}</span><span class="count">(${count})</span>`;
      if(selectedGroups.has(key)) b.classList.add('selected');
      b.addEventListener('click', ()=>{
        if(selectedGroups.has(key)) selectedGroups.delete(key); else selectedGroups.add(key);
        renderGroupChips(); render();
      });
      groupFilters.appendChild(b);
    });
  }
  clearGroups.addEventListener('click', (e)=>{
    e.preventDefault(); selectedGroups.clear(); renderGroupChips(); render();
  });

  // Filtered view
  function filteredContacts(){
    const q = norm(search);
    const hasSearch = q.length>0;
    const hasGroupFilter = selectedGroups.size>0;

    return st.contacts.filter(c=>{
      if(hasGroupFilter){
        const keys = (Array.isArray(c.group)? c.group : normalizeGroups(c.group)).map(g=>g.toLowerCase());
        if(!keys.some(k => selectedGroups.has(k))) return false;
      }
      if(!hasSearch) return true;
      const fields = [
        c.display_name, c.organisation, c.job_title, c.email, c.phone, c.mpdc_contact,
        (Array.isArray(c.group)? c.group.join(', ') : c.group), c.last_subject, c.notes
      ];
      return fields.some(v => norm(v).includes(q));
    });
  }

  // Render cycle
  let lastOrgsRendered = [];
  function render(){
    const contactsView = filteredContacts();
    const orgsView = deriveOrgs(contactsView);

    renderContacts(contactsView);
    renderOrgs(orgsView);
    renderInts(st.interactions);

    // Re-apply expanded orgs after re-render
    lastOrgsRendered = orgsView.map(o=>o.organisation);
    reapplyOrgExpanders();

    countContacts.textContent = contactsView.length ? `(${contactsView.length})` : '';
    countOrgs.textContent = orgsView.length ? `(${orgsView.length})` : '';
    countInts.textContent = st.interactions.length ? `(${st.interactions.length})` : '';
  }

  // CONTACTS (with mailto links + hover card)
  const contactBody = document.getElementById('tb-contacts');
  function renderContacts(list){
    const tb = contactBody;
    const rows = [...list].sort(by('display_name')).slice(0, limits.contacts);
    contactsById.clear();
    tb.innerHTML = rows.map(c=>{
      contactsById.set(String(c.id), c);
      const groups = (Array.isArray(c.group) ? c.group : normalizeGroups(c.group)).slice().sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
      const groupsHtml = groups.map(g=> `<span class="tag" title="${esc(g)}">${esc(g)}</span>`).join(' ');
      const email = clean(c.email);
      const emailHtml = email ? `<a class="mail" href="mailto:${encodeURIComponent(email)}" title="Email ${esc(c.display_name||email)}">${esc(email)}</a>` : '';
      return `
      <tr class="row-hoverable" data-id="${esc(String(c.id))}">
        <td class="w-name" title="${esc(c.display_name)}">${esc(c.display_name)}</td>
        <td class="w-org" title="${esc(c.organisation)}">${esc(c.organisation)}</td>
        <td class="w-group">${groupsHtml}</td>
        <td class="w-role" title="${esc(c.job_title)}">${esc(c.job_title)}</td>
        <td class="w-email">${emailHtml}</td>
        <td class="w-phone" title="${esc(c.phone)}">${esc(c.phone)}</td>
        <td class="w-mpdc" title="${esc(c.mpdc_contact)}">${esc(c.mpdc_contact)}</td>
        <td class="w-date">${fmtDate(c.last_contact_at)}</td>
        <td class="w-subj" title="${esc(c.last_subject)}">${esc(c.last_subject)}</td>
        <td class="w-notes" title="${esc(c.notes)}">${esc(c.notes)}</td>
      </tr>`;
    }).join('');
  }

  // Hover card behaviour
  function fillHover(c){
    HC.name.textContent = c.display_name || '(No name)';
    HC.org.textContent = c.organisation || 'â€”';
    HC.role.textContent = c.job_title || 'â€”';
    if(c.email){
      HC.email.innerHTML = `<a class="mail" href="mailto:${encodeURIComponent(c.email)}">${esc(c.email)}</a>`;
    }else{ HC.email.textContent = 'â€”'; }
    HC.phone.textContent = c.phone || 'â€”';
    HC.mpdc.textContent = c.mpdc_contact || 'â€”';
    const groups = (Array.isArray(c.group)? c.group : normalizeGroups(c.group));
    HC.groups.innerHTML = groups.map(g=>`<span class="tag" title="${esc(g)}">${esc(g)}</span>`).join('') || '<span class="muted">â€”</span>';
    HC.date.textContent = fmtDate(c.last_contact_at) || 'â€”';
    HC.subj.textContent = c.last_subject || 'â€”';
    HC.notes.textContent = c.notes || 'â€”';
  }
  function clamp(val, min, max){ return Math.max(min, Math.min(max, val)); }
  function positionHover(x, y){
    hc.style.display = 'block';
    // after visible, measure
    const rect = hc.getBoundingClientRect();
    const nx = clamp(x + 16, 8, window.innerWidth - rect.width - 8);
    const ny = clamp(y + 16, 8, window.innerHeight - rect.height - 8);
    hc.style.left = nx + 'px';
    hc.style.top  = ny + 'px';
  }
  function hideHover(){ if(!hoverSticky){ hc.style.display='none'; } }
  function showHoverForId(id, clientX, clientY){
    const c = contactsById.get(String(id));
    if(!c) return;
    fillHover(c);
    positionHover(clientX, clientY);
  }

  // Delegated mouse events for hover
  let hoverHideT = null;
  contactBody.addEventListener('mouseover', (e)=>{
    const tr = e.target.closest('tr[data-id]'); if(!tr) return;
    if(hoverHideT){ clearTimeout(hoverHideT); hoverHideT=null; }
    if(!hoverSticky){
      showHoverForId(tr.dataset.id, e.clientX, e.clientY);
    }
  });
  contactBody.addEventListener('mousemove', (e)=>{
    const tr = e.target.closest('tr[data-id]'); if(!tr) return;
    if(!hoverSticky && hc.style.display==='block'){
      positionHover(e.clientX, e.clientY);
    }
  });
  contactBody.addEventListener('mouseout', (e)=>{
    const toEl = e.relatedTarget;
    if(hc.contains(toEl)) return; // moving into card
    if(hoverSticky) return;
    hoverHideT = setTimeout(()=>{ hc.style.display='none'; }, 120);
  });

  // Click to pin/unpin
  contactBody.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr[data-id]'); if(!tr) return;
    const id = tr.dataset.id;
    if(hc.style.display!=='block'){ showHoverForId(id, e.clientX, e.clientY); }
    hoverSticky = true;
  });
  hc.addEventListener('mouseenter', ()=>{ if(hoverHideT){ clearTimeout(hoverHideT); hoverHideT=null; } });
  hc.addEventListener('mouseleave', ()=>{ if(!hoverSticky){ hc.style.display='none'; } });
  hcClose.addEventListener('click', ()=>{ hoverSticky=false; hc.style.display='none'; });
  document.addEventListener('click', (e)=>{
    if(hc.style.display==='none') return;
    const inCard = hc.contains(e.target);
    const inRow = e.target.closest && e.target.closest('tr[data-id]');
    if(!inCard && !inRow){ hoverSticky=false; hc.style.display='none'; }
  });
  window.addEventListener('scroll', ()=>{ if(!hoverSticky) hc.style.display='none'; });
  window.addEventListener('resize', ()=>{ if(!hoverSticky) hc.style.display='none'; });

  // ORGANISATIONS (click to expand)
  const orgBody = document.getElementById('tb-orgs');
  orgBody.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr[data-org]');
    if(!tr) return;
    const org = tr.dataset.org;
    toggleOrgExpander(org, tr);
  });
  function renderOrgs(list){
    const tb = orgBody;
    const rows = [...list].sort(by('organisation')).slice(0, limits.orgs);
    tb.innerHTML = rows.map(o=>`
      <tr data-org="${esc(o.organisation)}" tabindex="0" aria-expanded="${expandedOrgs.has(o.organisation)?'true':'false'}">
        <td class="w-org" title="${esc(o.organisation)}">${esc(o.organisation)}</td>
        <td title="${esc(o.contacts)}">${esc(o.contacts_preview || o.contacts)}</td>
        <td class="w-date">${fmtDate(o.last_contact_at)}</td>
        <td class="w-subj" title="${esc(o.recent_topics)}">${esc(o.recent_topics)}</td>
      </tr>
      ${expandedOrgs.has(o.organisation) ? buildOrgExpanderRow(o.organisation) : ''}
    `).join('');
  }
  function buildOrgExpanderRow(orgName){
    const all = filteredContacts().filter(c=> clean(c.organisation).toLowerCase() === clean(orgName).toLowerCase());
    const emails = all.map(c=> clean(c.email)).filter(Boolean);
    const mailAll = emails.length ? `mailto:${encodeURIComponent(emails.join(','))}` : null;
    const people = all.map(c=>{
      const gg = (Array.isArray(c.group)? c.group : normalizeGroups(c.group)).slice().sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
      const chip = gg.map(g=>`<span class="tag" title="${esc(g)}">${esc(g)}</span>`).join(' ');
      const email = clean(c.email);
      return `
        <div class="org-person">
          <span class="nm">${esc(c.display_name || '(No name)')}</span>
          ${c.job_title ? `<span class="sep">â€¢</span><span class="role">${esc(c.job_title)}</span>`:''}
          ${email ? `<span class="sep">â€¢</span><a class="mail" href="mailto:${encodeURIComponent(email)}">${esc(email)}</a>`:''}
          ${c.phone ? `<span class="sep">â€¢</span><span>${esc(c.phone)}</span>`:''}
          ${chip ? `<span class="sep">â€¢</span>${chip}`:''}
        </div>
      `;
    }).join('');
    return `
      <tr class="org-expander"><td colspan="4">
        <div class="org-card">
          <div class="org-actions">
            <h3 style="margin:0">${esc(orgName)}</h3>
            ${mailAll ? `<a class="btn" href="${mailAll}" title="Email all contacts at ${esc(orgName)}">Email all</a>`:''}
          </div>
          ${people ? `<div class="org-grid">${people}</div>` : `<div class="muted">No contacts (matches current filters)</div>`}
        </div>
      </td></tr>
    `;
  }
  function toggleOrgExpander(org, tr){
    const isOpen = expandedOrgs.has(org);
    if(isOpen){
      expandedOrgs.delete(org);
      const next = tr.nextElementSibling;
      if(next && next.classList.contains('org-expander')) next.remove();
      tr.setAttribute('aria-expanded','false');
    }else{
      expandedOrgs.add(org);
      tr.insertAdjacentHTML('afterend', buildOrgExpanderRow(org));
      tr.setAttribute('aria-expanded','true');
    }
  }
  function reapplyOrgExpanders(){
    const rows = Array.from(orgBody.querySelectorAll('tr[data-org]'));
    for(const r of rows){
      const org = r.dataset.org;
      const should = expandedOrgs.has(org) && lastOrgsRendered.includes(org);
      const next = r.nextElementSibling;
      const has = next && next.classList.contains('org-expander');
      if(should && !has){
        r.insertAdjacentHTML('afterend', buildOrgExpanderRow(org));
        r.setAttribute('aria-expanded','true');
      }
      if(!should && has){
        next.remove();
        r.setAttribute('aria-expanded','false');
      }
    }
    expandedOrgs.forEach(org=>{
      if(!lastOrgsRendered.includes(org)) expandedOrgs.delete(org);
    });
  }

  // INTERACTIONS
  function renderInts(list){
    const tb = document.getElementById('tb-ints');
    const rows = [...list].sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0, limits.ints);
    tb.innerHTML = rows.map(i=>`
      <tr>
        <td class="w-date">${fmtDate(i.date)}</td>
        <td class="w-name">${esc(i.contact)}</td>
        <td class="w-subj" title="${esc(i.subject)}">${esc(i.subject)}</td>
        <td title="${esc(i.summary)}">${esc(i.summary)}</td>
        <td>${esc(i.type)}</td>
      </tr>
    `).join('');
  }

  // Expand buttons
  function hookExpand(id, key){
    document.getElementById(id).addEventListener('click', ()=>{
      const isCollapsed = limits[key]===5;
      limits[key] = isCollapsed ? 99999 : 5;
      const tw = document.getElementById('tw-'+key);
      if(tw){ tw.style.maxHeight = isCollapsed ? '600px' : '420px'; }
      document.getElementById(id).textContent = isCollapsed ? 'Show fewer' : 'Expand list';
      render();
    });
  }
  hookExpand('expContacts','contacts');
  hookExpand('expOrgs','orgs');
  hookExpand('expInts','ints');

  // CSV header finder
  function finder(headers){
    const normKey = x => x.toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9]/g,'');
    const map = {}; headers.forEach(h=> map[normKey(h)] = h);
    return (...cands)=> { for(const c of cands){ const hit = map[normKey(c)]; if(hit) return hit; } return null; };
  }

  // CSV â†’ state
  function csvToState(csvText){
    return new Promise((resolve)=>{
      Papa.parse(csvText,{
        header:true,
        skipEmptyLines:true,
        transformHeader: h=>h.trim(),
        complete: res=>{
          const headers = res.meta.fields||[];
          const find = finder(headers);
          const H = {
            name: find('Name','Title','Full Name','display_name'),
            organisation: find('Organisation','Organization'),
            group: find('Group','Groups','Stakeholder Group'),
            role: find('Role','Job Title','Position','job_title'),
            email: find('Email','E-mail'),
            phone: find('Phone','Phone number','Mobile'),
            mpdc: find('MPDC contact','MPDC Contact','MPDC_contact','mpdc_contact'),
            lastDate: find('Last contact','Latest interactions','Latest Interaction Date','Last Contact Date','last_contact'),
            lastSubj: find('Last subject','Latest interaction subject','Latest Interaction Subject','last_subject'),
            notes: find('Notes','Comment','Comments','notes')
          };
          let id = 1;
          const contacts = res.data.map(r=>{
            const groups = normalizeGroups(r[H.group]);
            return {
              id: id++,
              display_name: clean(r[H.name]),
              email: clean(r[H.email]),
              organisation: clean(r[H.organisation]),
              group: groups,
              job_title: clean(r[H.role]),
              phone: clean(r[H.phone]),
              mpdc_contact: clean(r[H.mpdc]) || 'communications@macpoint.com',
              last_contact_at: toISOorBlank(clean(r[H.lastDate])),
              last_subject: clean(r[H.lastSubj]),
              notes: clean(r[H.notes])
            };
          }).filter(c=> Object.values(c).some(v=> String(v||'').length));
          const organisations = deriveOrgs(contacts);
          resolve({organisations, contacts, interactions: []});
        }
      });
    });
  }

  // Export checkboxes
  function buildExportChecks(){
    colChecks.innerHTML = '';
    DEFAULT_COLUMNS.forEach(c=>{
      const id = 'col_'+c.key;
      const w = document.createElement('label');
      w.innerHTML = `<input type="checkbox" id="${id}" ${c.checked?'checked':''}/> ${c.label}`;
      colChecks.appendChild(w);
    });
  }
  buildExportChecks();

  // Buttons & inputs
  document.getElementById('btnLoadCsv').addEventListener('click', ()=> document.getElementById('fileCsv').click());
  document.getElementById('btnLoadJson').addEventListener('click', ()=> document.getElementById('fileJson').click());

  document.getElementById('fileCsv').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    st = await csvToState(text);
    limits = {contacts:5,orgs:5,ints:5};
    chip.className='chip ok'; chip.textContent='Data: loaded from CSV (local)';
    setLastUpdated(new Date());
    rebuildGroupIndex(); render();
  });

  document.getElementById('fileJson').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      st = {
        organisations: data.organisations||[],
        contacts: (data.contacts||[]).map(c=> ({...c, group: normalizeGroups(c.group)})),
        interactions: data.interactions||[],
        _meta: data._meta||null
      };
      if((st.organisations||[]).length===0 && (st.contacts||[]).length>0){
        st.organisations = deriveOrgs(st.contacts);
      }
      limits = {contacts:5,orgs:5,ints:5};
      chip.className='chip ok'; chip.textContent='Data: loaded from JSON (local)';
      setLastUpdated(data && data._meta && data._meta.updated_at ? data._meta.updated_at : new Date());
      rebuildGroupIndex(); render();
    }catch(err){ alert('Invalid JSON file'); }
  });

  // JSON download
  document.getElementById('btnDlJson').addEventListener('click', ()=>{
    const out = {
      organisations: st.organisations||[],
      contacts: (st.contacts||[]).map(c=> ({...c, group: normalizeGroups(c.group)})),
      interactions: st.interactions||[],
      _meta: { updated_at: new Date().toISOString(), source: 'manual-export', contact_count: st.contacts?.length || 0 }
    };
    const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'data.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Export CSV
  btnExportCsv.addEventListener('click', ()=> exportPanel.classList.toggle('open'));
  btnCancelExport.addEventListener('click', ()=> exportPanel.classList.remove('open'));
  document.addEventListener('click', (e)=>{
    if(!exportPanel.contains(e.target) && e.target!==btnExportCsv){
      exportPanel.classList.remove('open');
    }
  });
  btnDoExport.addEventListener('click', ()=>{
    const scope = document.querySelector('input[name="exportScope"]:checked')?.value || 'filtered';
    const list = scope==='all' ? st.contacts : filteredContacts();

    const chosen = Array.from(colChecks.querySelectorAll('input[type="checkbox"]'))
      .filter(x=>x.checked).map(x=> x.id.replace('col_',''));
    if(chosen.length===0){ alert('Select at least one column.'); return; }

    const labelMap = {
      display_name:'Name', organisation:'Organisation', group:'Group', job_title:'Role',
      email:'Email', phone:'Phone', mpdc_contact:'MPDC contact',
      last_contact_at:'Last contact', last_subject:'Last subject', notes:'Notes'
    };

    const rows = list.map(c=>{
      const row = {};
      chosen.forEach(k=>{
        let v = c[k];
        if(k==='group') v = normalizeGroups(v).join(', ');
        if(k==='last_contact_at') v = c.last_contact_at ? fmtDate(c.last_contact_at) : '';
        row[labelMap[k]] = v ?? '';
      });
      return row;
    });

    const csv = Papa.unparse(rows);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const nameBit = scope==='all' ? 'all' : 'filtered';
    a.download = `contacts_${nameBit}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
    exportPanel.classList.remove('open');
  });

  // Reload remote JSON
  btnReload.addEventListener('click', ()=> init(true));

  // Search
  let tSearch;
  function setSearch(val){ search = val; render(); }
  searchBox.addEventListener('input', ()=>{
    clearTimeout(tSearch);
    const v = searchBox.value;
    tSearch = setTimeout(()=> setSearch(v), 120);
  });
  btnClearSearch.addEventListener('click', ()=>{
    searchBox.value = '';
    setSearch('');
    searchBox.focus();
  });

  // Initial load
  async function init(forceNoCache=false){
    try{
       const r = await fetch(DATA_URL, {cache: forceNoCache?'no-store':'default'});
       if(!r.ok) throw new Error('HTTP '+r.status);
       const data = await r.json();
       st = {
         organisations: data.organisations||[],
         contacts: (data.contacts||[]).map(c=> ({...c, group: normalizeGroups(c.group)})),
         interactions: data.interactions||[],
         _meta: data._meta||null
       };
       if((st.organisations||[]).length===0 && (st.contacts||[]).length>0){
         st.organisations = deriveOrgs(st.contacts);
       }
       chip.className='chip ok';
       const total = st.contacts?.length || 0;
       chip.textContent = `Data: Connected âœ“ â€” ${total} contacts`;

       let updated = (data && data._meta && data._meta.updated_at) ? data._meta.updated_at : r.headers.get('last-modified');
       setLastUpdated(updated || new Date());

       limits = {contacts:5,orgs:5,ints:5};
       rebuildGroupIndex(); render();
    }catch(err){
       chip.className='chip';
       chip.textContent='Data: local only (no remote)';
       setLastUpdated(null);
       rebuildGroupIndex(); render();
    }
  }
  init();
})();
</script>
</body>
</html>
