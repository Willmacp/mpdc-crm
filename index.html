<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MPDC Stakeholder CRM</title>
  <meta name="x-build" content="r14-sp"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --accent:#5f809b; --accent-dark:#4a667f; --accent-50:#eef3f6; --gray:#6d6e71; --text:#1f2937; --border:#e5e7eb; --row-alt:#fafbfc; --row-hover:#f7fafc; }
    html{scroll-behavior:smooth;} body{color:var(--text);}
    header.site-header{background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.08);}
    .nav-link{color:#fff;opacity:.95;padding:.35rem .6rem;border-radius:999px;transition:all .15s;border:1px solid transparent;}
    .nav-link:hover{opacity:1;background:#fff;color:var(--accent);border-color:#ffffff33;text-decoration:none;}
    .nav-link.active{background:#fff;color:var(--accent);border-color:#ffffff55;}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .9rem;border-radius:.55rem;font-weight:600;transition:all .15s;}
    .btn-accent{background:var(--accent);color:#fff;border:1px solid var(--accent);}
    .btn-accent:hover{background:var(--accent-dark);border-color:var(--accent-dark);transform:translateY(-1px);}
    .btn-outline{background:#fff;color:var(--accent);border:1px solid var(--accent);}
    .btn-outline:hover{background:var(--accent-50);}
    .datawrap{overflow:auto;background:#fff;border:1px solid var(--border);border-radius:.75rem;}
    .table-ish{width:100%;border-collapse:separate;border-spacing:0;min-width:1200px;}
    .table-ish thead th{position:sticky;top:0;z-index:10;background:var(--accent-50);border-bottom:1px solid var(--border);padding:.6rem;text-align:left;white-space:nowrap;font-weight:700;color:#273646;letter-spacing:.01em;user-select:none;}
    .table-ish tbody td{border-bottom:1px solid var(--border);padding:.55rem;vertical-align:middle;}
    .table-ish tbody tr:last-child td{border-bottom:0;}
    .table-ish tbody tr:nth-child(even){background:var(--row-alt);}
    .row{transition:background .15s,box-shadow .15s;}
    .row:hover{background:var(--row-hover);}
    .row:hover td:first-child{box-shadow: inset 3px 0 0 var(--accent);}
    .cell{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;}
    .chip{display:inline-block;padding:.2rem .5rem;font-size:.75rem;border-radius:999px;background:#fff;border:1px solid var(--accent);color:#273646;}
    .chip:hover{background:var(--accent-50);}
    .w-name{width:180px}.w-org{width:220px}.w-group{width:160px}.w-role{width:160px}.w-email{width:220px}.w-phone{width:140px}.w-mpdc{width:160px}.w-last{width:150px}.w-subj{width:220px}.w-notes{width:260px}
    .datawrap::-webkit-scrollbar{height:12px;width:12px}.datawrap::-webkit-scrollbar-track{background:#fff;border-radius:10px}
    .datawrap::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent),var(--accent-dark));border:3px solid #fff;border-radius:10px}
    .datawrap::-webkit-scrollbar-thumb:hover{filter:brightness(.95)}
    .section-title{color:#273646;}
    .badge{display:inline-block;margin-left:.5rem;font-size:.75rem;line-height:1;padding:.25rem .5rem;border-radius:999px;background:var(--accent-50);color:#273646;border:1px solid var(--accent);vertical-align:middle;}
    footer.site-footer{background:var(--accent-50);border-top:1px solid var(--border);color:#334155;}
    #scrollTopBtn{position:fixed;right:16px;bottom:16px;z-index:50;opacity:0;pointer-events:none;transform:translateY(8px);transition:all .2s;}
    #scrollTopBtn.show{opacity:1;pointer-events:auto;transform:translateY(0);}
    #errbox{position:fixed;bottom:12px;right:12px;max-width:560px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.2);font:12px ui-sans-serif,system-ui;display:none;z-index:9999;white-space:pre-wrap}
    .muted{opacity:.7}
  </style>
</head>
<body class="bg-gray-50">
  <header id="top" class="site-header sticky top-0 z-10 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-4">
      <div class="font-bold text-lg">MPDC Stakeholder CRM</div>
      <nav class="ml-auto flex items-center gap-2 text-sm">
        <a href="#contacts" class="nav-link" id="nav-contacts">Contacts</a>
        <a href="#organisations" class="nav-link" id="nav-organisations">Organisations</a>
        <a href="#interactions" class="nav-link" id="nav-interactions">Interactions</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <section id="dashboard" class="mb-8">
      <div class="flex items-end justify-between gap-3 flex-wrap">
        <h1 class="section-title text-2xl font-semibold">Stakeholder overview</h1>
        <div class="flex items-center gap-2">
          <input id="search" class="border rounded px-3 py-2 w-72" placeholder="Search contacts, orgs, subjectsâ€¦"/>
          <button id="exportBtn" class="btn btn-accent">Export</button>
        </div>
      </div>
      <div id="summary" class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
    </section>

    <!-- Contacts -->
    <section id="contacts" class="mb-10">
      <div class="flex items-center justify-between mb-2">
        <h2 class="section-title text-xl font-semibold">
          Contacts <span id="countContacts" class="badge">0</span>
        </h2>
        <div class="flex items-center gap-2 text-sm">
          <button id="toggleContacts" class="btn btn-outline">Expand list</button>
        </div>
      </div>
      <div id="contactsWrap" class="datawrap">
        <table id="contactsTable" class="table-ish">
          <thead>
            <tr>
              <th class="cell w-name">Name</th>
              <th class="cell w-org">Organisation</th>
              <th class="cell w-group">Group</th>
              <th class="cell w-role">Role</th>
              <th class="cell w-email">Email</th>
              <th class="cell w-phone">Phone</th>
              <th class="cell w-mpdc">MPDC contact</th>
              <th class="cell w-last">Last contact</th>
              <th class="cell w-subj">Last subject</th>
              <th class="cell w-notes">Notes</th>
            </tr>
          </thead>
          <tbody id="contactsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Organisations -->
    <section id="organisations" class="mb-10">
      <div class="flex items-center justify-between mb-2">
        <h2 class="section-title text-xl font-semibold">
          Organisations <span id="countOrgs" class="badge">0</span>
        </h2>
        <div class="flex items-center gap-2 text-sm">
          <button id="toggleOrgs" class="btn btn-outline">Expand list</button>
        </div>
      </div>
      <div id="orgsWrap" class="datawrap">
        <table id="orgsTable" class="table-ish">
          <thead>
            <tr>
              <th class="cell">Organisation</th>
              <th class="cell">Contacts</th>
              <th class="cell">Last contact</th>
              <th class="cell">Recent topics</th>
            </tr>
          </thead>
          <tbody id="orgsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Interactions -->
    <section id="interactions" class="mb-10">
      <div class="flex items-center justify-between mb-2">
        <h2 class="section-title text-xl font-semibold">
          Interactions <span id="countInts" class="badge">0</span>
        </h2>
        <div class="flex items-center gap-2 text-sm">
          <button id="toggleInts" class="btn btn-outline">Expand list</button>
        </div>
      </div>
      <div id="intsWrap" class="datawrap">
        <table id="intsTable" class="table-ish">
          <thead>
            <tr>
              <th class="cell">Date</th>
              <th class="cell">Contact</th>
              <th class="cell">Subject</th>
              <th class="cell">Summary</th>
              <th class="cell">Type</th>
            </tr>
          </thead>
          <tbody id="intsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="max-w-7xl mx-auto px-4 py-6 text-sm flex items-center justify-between gap-3 flex-wrap">
      <div>MPDC Stakeholder CRM â€” please talk to the Comms team for assistance or to suggest edits. <span class="muted">Build r14 (SP)</span></div>
      <a class="btn btn-outline" href="#top">Back to top</a>
    </div>
  </footer>

  <button id="scrollTopBtn" class="btn btn-accent" aria-label="Back to top" title="Back to top">â–²</button>
  <div id="errbox"></div>
  <script id="sample-data" type="application/json">{"organisations":[],"contacts":[],"interactions":[]}</script>

  <script>
  'use strict';

  const Err=(()=>{const b=document.getElementById('errbox');return{show:m=>{b.style.display='block';b.textContent=String(m);console.error(m)},log:(...a)=>console.log(...a)}})();

  // Robust array getter (handles SharePoint shapes like {body:[...]} or {value:[...]})
  const toArr=v=>Array.isArray(v)?v:(Array.isArray(v?.body)?v.body:(Array.isArray(v?.value)?v.value:[]));
  const safe=s=>(s??'').toString();
  const fmtDate=iso=>iso?new Date(iso).toLocaleString():'';
  const ROWS_WHEN_COLLAPSED=5;

  // ðŸ”— SharePoint edition: only fetch from same folder
  const SOURCE="./data.json";

  let state={organisations:[],contacts:[],interactions:[]};
  let filtered={organisations:[],contacts:[],interactions:[]};
  let expand={organisations:false,contacts:false,interactions:false};

  function trimWeirdKeys(o){Object.keys(o||{}).forEach(k=>{const tk=k.trim();if(tk!==k && !(tk in o)){o[tk]=o[k];delete o[k];}});return o;}
  function normalizeGroup(v){if(Array.isArray(v)){return v.map(x=>(x?.Value||x?.value||x?.Title||x?.title||'')).filter(Boolean).join(', ')}return (v??'').toString()}
  function fallbackName(c){const email=(c.email||'').split(';')[0].trim();const em=email.includes('@')?email.split('@')[0]:'';return (c.display_name||c.name||c.Title||em||c.organisation||'').trim();}

  function coerceData(raw){
    if(Array.isArray(raw)) return {organisations:[],contacts:raw,interactions:[]};
    if(!raw||typeof raw!=='object') return {organisations:[],contacts:[],interactions:[]};
    const contacts = toArr(raw.contacts||raw.Contacts||raw.items||raw.value||raw);
    const organisations = toArr(raw.organisations||raw.Organisations||[]);
    const interactions = toArr(raw.interactions||raw.Interactions||[]);
    return {organisations,contacts,interactions};
  }

  function normalizeData(raw){
    const c=coerceData(raw);
    const contacts=toArr(c.contacts).map(it=>{const x=trimWeirdKeys({...it});
      x.group=normalizeGroup(x.group); x.display_name=fallbackName(x);
      x.job_title=x.job_title??x.role??x.position??''; x.mpdc_contact=x.mpdc_contact??x.owner??'';
      x.email=(x.email||'').toString(); x.phone=(x.phone||'').toString();
      x.org_name=x.org_name||x.organisation||'';
      x.last_subject=x.last_subject||x['last_subject']||x['last_subject     ']||x.latest_interaction_subject||x.latest_interaction_summary||'';
      x.latest_interaction_at=x.latest_interaction_at||x.latest_interaction_date||null;
      return x;
    });
    const orgs=toArr(c.organisations).map(o=>({id:o.id||o.name||o.title||'',name:o.name||o.title||''}));
    const ints=toArr(c.interactions).map(i=>trimWeirdKeys({...i}));
    return {organisations:orgs,contacts,interactions:ints};
  }

  function derive(st){
    const orgs=toArr(st.organisations), contacts=toArr(st.contacts), ints=toArr(st.interactions);
    const orgMap=new Map(orgs.map(o=>[o.id,o])); const contactMap=new Map(contacts.map(c=>[c.id,c]));
    const byC=new Map(); ints.forEach(i=>{if(!i?.contact_id) return;(byC.get(i.contact_id)||byC.set(i.contact_id,[]).get(i.contact_id)).push(i);});
    contacts.forEach(c=>{const list=(byC.get(c.id)||[]).sort((a,b)=>new Date(b.occurred_at)-new Date(a.occurred_at));
      c.last_contact_at=list[0]?.occurred_at||c.latest_interaction_at||null;
      c.last_subject=c.last_subject||list[0]?.subject||'';
      c.org_name=c.org_name||orgMap.get(c.organisation_id)?.name||c.organisation||'';
    });
    const byO=new Map(); ints.forEach(i=>{const ct=contactMap.get(i.contact_id);const oid=ct?.organisation_id;if(!oid)return;(byO.get(oid)||byO.set(oid,[]).get(oid)).push(i);});
    orgs.forEach(o=>{const list=(byO.get(o.id)||[]).sort((a,b)=>new Date(b.occurred_at)-new Date(a.occurred_at));
      o.last_contact_at=list[0]?.occurred_at||null;
      o.contact_count=contacts.filter(c=>c.organisation_id===o.id).length;
      const subjects=list.slice(0,6).map(i=>i.subject||'').join(' ');
      const tokens=subjects.toLowerCase().split(/[^a-z0-9]+/).filter(t=>t&&t.length>3);
      const freq={}; tokens.forEach(t=>freq[t]=(freq[t]||0)+1);
      o.topics=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,4).map(([w])=>w);
    });
    st.organisations=orgs; st.contacts=contacts; st.interactions=ints;
  }

  function adjustWrapHeight(wrapId,tableId,rows){const w=document.getElementById(wrapId),t=document.getElementById(tableId);if(!w||!t)return;const h=t.querySelector('thead')?.offsetHeight||40;const r=t.querySelector('tbody tr')?.offsetHeight||40;w.style.maxHeight=(h+r*rows)+'px'}

  function renderContacts(list){
    list=toArr(list); const w=document.getElementById('contactsWrap'); const vis=expand.contacts?list:list.slice(0,5);
    const rows=vis.map(c=>`<tr class="row">
      <td class="cell w-name"  title="${safe(c.display_name)}">${safe(c.display_name)}</td>
      <td class="cell w-org"   title="${safe(c.org_name)}">${safe(c.org_name)}</td>
      <td class="cell w-group" title="${safe(c.group)}">${safe(c.group)}</td>
      <td class="cell w-role"  title="${safe(c.job_title)}">${safe(c.job_title)}</td>
      <td class="cell w-email" title="${safe(c.email)}">${c.email?`<a class="hover:underline" href="mailto:${safe(c.email)}">${safe(c.email)}</a>`:''}</td>
      <td class="cell w-phone" title="${safe(c.phone)}">${safe(c.phone)}</td>
      <td class="cell w-mpdc"  title="${safe(c.mpdc_contact)}">${safe(c.mpdc_contact)}</td>
      <td class="cell w-last"  title="${c.last_contact_at?fmtDate(c.last_contact_at):''}">${c.last_contact_at?fmtDate(c.last_contact_at):'â€”'}</td>
      <td class="cell w-subj"  title="${safe(c.last_subject)}">${safe(c.last_subject)}</td>
      <td class="cell w-notes" title="${safe(c.notes)}">${safe(c.notes)}</td>
    </tr>`).join('');
    document.getElementById('contactsBody').innerHTML=rows||`<tr><td class="p-3 text-center text-gray-500" colspan="10">No contacts</td></tr>`;
    if(w){adjustWrapHeight('contactsWrap','contactsTable',expand.contacts?20:5)}
  }

  function renderOrgs(list){
    list=toArr(list); const w=document.getElementById('orgsWrap'); const vis=expand.organisations?list:list.slice(0,5);
    const rows=vis.map(o=>`<tr class="row">
      <td class="cell" title="${safe(o.name)}">${safe(o.name)}</td>
      <td class="cell" title="${o.contact_count||0}">${o.contact_count||0}</td>
      <td class="cell" title="${o.last_contact_at?fmtDate(o.last_contact_at):''}">${o.last_contact_at?fmtDate(o.last_contact_at):'â€”'}</td>
      <td class="cell">${(o.topics||[]).map(t=>`<span class="chip">${t}</span>`).join(' ')}</td>
    </tr>`).join('');
    document.getElementById('orgsBody').innerHTML=rows||`<tr><td class="p-3 text-center text-gray-500" colspan="4">No organisations</td></tr>`;
    if(w){adjustWrapHeight('orgsWrap','orgsTable',expand.organisations?20:5)}
  }

  function renderInts(list){
    list=toArr(list); const w=document.getElementById('intsWrap'); const vis=expand.interactions?list:list.slice(0,5);
    const cmap=new Map(toArr(state.contacts).map(c=>[c.id,c]));
    const rows=vis.map(i=>{const c=cmap.get(i.contact_id); const who=c?safe(c.display_name):'';return `<tr class="row">
      <td class="cell" title="${i.occurred_at?fmtDate(i.occurred_at):''}">${fmtDate(i.occurred_at)}</td>
      <td class="cell" title="${who}">${who}</td>
      <td class="cell" title="${safe(i.subject)}">${safe(i.subject)}</td>
      <td class="cell" title="${safe(i.summary)}">${safe(i.summary)}</td>
      <td class="cell" title="${safe(i.type)}">${safe(i.type)}</td>
    </tr>`}).join('');
    document.getElementById('intsBody').innerHTML=rows||`<tr><td class="p-3 text-center text-gray-500" colspan="5">No interactions</td></tr>`;
    if(w){adjustWrapHeight('intsWrap','intsTable',expand.interactions?20:5)}
  }

  function renderSummary(){
    const c=toArr(state.contacts).length, o=toArr(state.organisations).length, l7=toArr(state.interactions).filter(i=>i.occurred_at&&(Date.now()-new Date(i.occurred_at))<7*864e5).length;
    document.getElementById('summary').innerHTML=`<div class="p-4 bg-white border rounded-lg"><div class="text-sm text-[color:var(--gray)]">Contacts</div><div class="text-2xl font-semibold">${c}</div></div>
    <div class="p-4 bg-white border rounded-lg"><div class="text-sm text-[color:var(--gray)]">Organisations</div><div class="text-2xl font-semibold">${o}</div></div>
    <div class="p-4 bg-white border rounded-lg"><div class="text-sm text-[color:var(--gray)]">Interactions (7 days)</div><div class="text-2xl font-semibold">${l7}</div></div>`;
  }

  function applySearch(q){
    const n=(q||'').trim().toLowerCase(), s=x=>(x??'').toString();
    if(!n){ filtered.contacts=[...toArr(state.contacts)]; filtered.organisations=[...toArr(state.organisations)]; filtered.interactions=[...toArr(state.interactions)]; return;}
    filtered.contacts=toArr(state.contacts).filter(c=>[c.display_name,c.email,c.org_name,c.group,c.job_title,c.mpdc_contact,c.notes].some(v=>s(v).toLowerCase().includes(n)));
    filtered.organisations=toArr(state.organisations).filter(o=>s(o.name).toLowerCase().includes(n));
    filtered.interactions=toArr(state.interactions).filter(i=>{const c=toArr(state.contacts).find(x=>x.id===i.contact_id);return [i.subject,i.summary,c?.display_name,c?.email].some(v=>s(v).toLowerCase().includes(n))});
  }

  function renderAll(){
    renderSummary(); renderContacts(filtered.contacts||[]); renderOrgs(filtered.organisations||[]); renderInts((filtered.interactions||[]).sort((a,b)=>new Date(b.occurred_at)-new Date(a.occurred_at)));
    document.getElementById('toggleContacts').textContent=expand.contacts?'Collapse list':'Expand list';
    document.getElementById('toggleOrgs').textContent=expand.organisations?'Collapse list':'Expand list';
    document.getElementById('toggleInts').textContent=expand.interactions?'Collapse list':'Expand list';
    document.getElementById('countContacts').textContent=toArr(filtered.contacts).length;
    document.getElementById('countOrgs').textContent=toArr(filtered.organisations).length;
    document.getElementById('countInts').textContent=toArr(filtered.interactions).length;
  }

  (function(){const b=document.getElementById('scrollTopBtn');const onS=()=>{if(window.scrollY>500)b.classList.add('show');else b.classList.remove('show')};b.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));window.addEventListener('scroll',onS,{passive:true});onS()})();

  (async function init(){
    try{
      const resp=await fetch(SOURCE+'?v='+Date.now(),{cache:'no-store'});
      if(!resp.ok) throw new Error('HTTP '+resp.status+' fetching '+SOURCE);
      const text=await resp.text();
      const raw=JSON.parse(text);
      state=normalizeData(raw); derive(state);
      filtered.contacts=[...toArr(state.contacts)];
      filtered.organisations=[...toArr(state.organisations)];
      filtered.interactions=[...toArr(state.interactions)];
      renderAll();
    }catch(e){
      Err.show('Init error (r14-sp): '+(e.message||e));
      try{const fb=JSON.parse(document.getElementById('sample-data').textContent);state=fb;filtered=fb;renderAll()}catch{}
    }
    document.getElementById('search')?.addEventListener('input',e=>{applySearch(e.target.value);renderAll()});
    document.getElementById('exportBtn')?.addEventListener('click',()=>{
      const cols=[{header:'Name',get:r=>r.display_name||''},{header:'Organisation',get:r=>r.org_name||''},{header:'Group',get:r=>r.group||''},{header:'Role',get:r=>r.job_title||''},{header:'Email',get:r=>r.email||''},{header:'Phone',get:r=>r.phone||''},{header:'MPDC contact',get:r=>r.mpdc_contact||''},{header:'Last contact',get:r=>r.last_contact_at||''},{header:'Last subject',get:r=>r.last_subject||''},{header:'Notes',get:r=>r.notes||''}];
      const esc=v=>{const s=(v==null?'':String(v));return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s};
      const head=cols.map(c=>esc(c.header)).join(','); const body=toArr(filtered.contacts).map(r=>cols.map(c=>esc(c.get(r))).join(',')).join('\n');
      const csv='\uFEFF'+head+'\n'+body; const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='contacts_export.csv'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('toggleContacts')?.addEventListener('click',()=>{expand.contacts=!expand.contacts;renderAll()});
    document.getElementById('toggleOrgs')?.addEventListener('click',()=>{expand.organisations=!expand.organisations;renderAll()});
    document.getElementById('toggleInts')?.addEventListener('click',()=>{expand.interactions=!expand.interactions;renderAll()});
  })();
  </script>
</body>
</html>
